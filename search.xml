<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Docker企业级部署Seata分布式事务（Nacos + MySQL + Oracle支持）</title>
    <url>/2026/02/06/Docker%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%83%A8%E7%BD%B2Seata%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%88Nacos-+-MySQL-+-Oracle%E6%94%AF%E6%8C%81%EF%BC%89/</url>
    <content><![CDATA[<h1 id="一、Seata简介"><a href="#一、Seata简介" class="headerlink" title="一、Seata简介"></a>一、Seata简介</h1><p>Seata 是一款开源的分布式事务解决方案，支持：</p>
<ul>
<li>AT 模式（最常用）</li>
<li>TCC 模式</li>
<li>SAGA 模式</li>
<li>XA 模式</li>
</ul>
<p>核心组件：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>TC</td>
<td>事务协调器（Seata Server）</td>
</tr>
<tr>
<td>TM</td>
<td>事务管理器（发起事务的服务）</td>
</tr>
<tr>
<td>RM</td>
<td>资源管理器（数据库操作服务）</td>
</tr>
</tbody>
</table>
</div>
<p>核心流程：</p>
<ol>
<li>TM 开启全局事务</li>
<li>TC 生成 XID</li>
<li>XID 在服务间传播</li>
<li>RM 注册分支事务</li>
<li>TM 决议提交或回滚</li>
<li>TC 通知所有RM执行</li>
</ol>
<hr>
<h1 id="二、环境准备"><a href="#二、环境准备" class="headerlink" title="二、环境准备"></a>二、环境准备</h1><h2 id="1、软件环境"><a href="#1、软件环境" class="headerlink" title="1、软件环境"></a>1、软件环境</h2><p>Docker &gt;= 23<br>Nacos &gt;= 2.2<br>MySQL 或 Oracle<br>JDK 8+</p>
<hr>
<h2 id="2、目录规划（企业标准）"><a href="#2、目录规划（企业标准）" class="headerlink" title="2、目录规划（企业标准）"></a>2、目录规划（企业标准）</h2><p>/data/docker/seata<br>/data/docker/seata/resources<br>/data/docker/seata/logs</p>
<p>创建目录：</p>
<p>mkdir -p /data/docker/seata/resources<br>mkdir -p /data/docker/seata/logs</p>
<hr>
<h1 id="三、拉取Seata镜像"><a href="#三、拉取Seata镜像" class="headerlink" title="三、拉取Seata镜像"></a>三、拉取Seata镜像</h1><h2 id="1、查看镜像"><a href="#1、查看镜像" class="headerlink" title="1、查看镜像"></a>1、查看镜像</h2><p>docker search seata</p>
<p>推荐官方镜像：</p>
<p>seataio/seata-server</p>
<hr>
<h2 id="2、拉取指定稳定版本（推荐）"><a href="#2、拉取指定稳定版本（推荐）" class="headerlink" title="2、拉取指定稳定版本（推荐）"></a>2、拉取指定稳定版本（推荐）</h2><p>docker pull seataio/seata-server:1.6.1</p>
<p>查看：</p>
<p>docker images</p>
<hr>
<h1 id="四、创建Seata数据库"><a href="#四、创建Seata数据库" class="headerlink" title="四、创建Seata数据库"></a>四、创建Seata数据库</h1><p>下载官方脚本：</p>
<p><a href="https://github.com/apache/incubator-seata/tree/master/script/server/db">https://github.com/apache/incubator-seata/tree/master/script/server/db</a></p>
<p>创建数据库：</p>
<p>CREATE DATABASE seata;</p>
<p>执行：</p>
<p>mysql.sql</p>
<hr>
<h1 id="五、初始化配置文件"><a href="#五、初始化配置文件" class="headerlink" title="五、初始化配置文件"></a>五、初始化配置文件</h1><h2 id="1、先启动一次容器"><a href="#1、先启动一次容器" class="headerlink" title="1、先启动一次容器"></a>1、先启动一次容器</h2><p>docker run -d —name seata-temp<br>-p 7091:7091<br>seataio/seata-server:1.6.1</p>
<hr>
<h2 id="2、复制配置"><a href="#2、复制配置" class="headerlink" title="2、复制配置"></a>2、复制配置</h2><p>docker cp seata-temp:/seata-server/resources /data/docker/seata/</p>
<hr>
<h2 id="3、删除临时容器"><a href="#3、删除临时容器" class="headerlink" title="3、删除临时容器"></a>3、删除临时容器</h2><p>docker rm -f seata-temp</p>
<hr>
<h1 id="六、修改-application-yml（企业版）"><a href="#六、修改-application-yml（企业版）" class="headerlink" title="六、修改 application.yml（企业版）"></a>六、修改 application.yml（企业版）</h1><p>server:<br>port: 7091</p>
<p>spring:<br>application:<br>name: seata-server</p>
<p>console:<br>user:<br>username: seata<br>password: seata</p>
<p>seata:<br>config:<br>type: nacos<br>nacos:<br>server-addr: 192.168.1.10:8848<br>group: SEATA_GROUP<br>username: nacos<br>password: nacos<br>data-id: seata.properties</p>
<p>registry:<br>type: nacos<br>nacos:<br>application: seata-server<br>server-addr: 192.168.1.10:8848<br>group: SEATA_GROUP<br>cluster: default<br>username: nacos<br>password: nacos</p>
<p>store:<br>mode: db<br>db:<br>datasource: druid<br>db-type: mysql<br>driver-class-name: com.mysql.jdbc.Driver<br>url: jdbc:mysql://192.168.1.20:3306/seata<br>user: root<br>password: 123456</p>
<p>security:<br>secretKey: SeataSecretKey<br>tokenValidityInMilliseconds: 1800000</p>
<hr>
<h1 id="七、Nacos配置中心配置"><a href="#七、Nacos配置中心配置" class="headerlink" title="七、Nacos配置中心配置"></a>七、Nacos配置中心配置</h1><p>创建：</p>
<p>DataId: seata.properties<br>Group: SEATA_GROUP</p>
<p>内容：</p>
<p>store.mode=db<br>store.db.dbType=mysql<br>store.db.url=jdbc:mysql://192.168.1.20:3306/seata<br>store.db.user=root<br>store.db.password=123456</p>
<hr>
<h1 id="八、正式启动Seata（生产版）"><a href="#八、正式启动Seata（生产版）" class="headerlink" title="八、正式启动Seata（生产版）"></a>八、正式启动Seata（生产版）</h1><p>docker run -d<br>—name seata<br>—restart=always<br>-p 8091:8091<br>-p 7091:7091<br>-e SEATA_IP=192.168.1.30<br>-v /data/docker/seata/resources:/seata-server/resources<br>-v /data/docker/seata/logs:/root/logs<br>seataio/seata-server:1.6.1</p>
<hr>
<h1 id="九、验证部署"><a href="#九、验证部署" class="headerlink" title="九、验证部署"></a>九、验证部署</h1><h2 id="查看容器"><a href="#查看容器" class="headerlink" title="查看容器"></a>查看容器</h2><p>docker ps</p>
<h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><p>docker logs -f seata</p>
<h2 id="查看Nacos"><a href="#查看Nacos" class="headerlink" title="查看Nacos"></a>查看Nacos</h2><p>服务列表出现 seata-server</p>
<hr>
<h1 id="十、微服务接入Seata"><a href="#十、微服务接入Seata" class="headerlink" title="十、微服务接入Seata"></a>十、微服务接入Seata</h1><p>入口方法：</p>
<p>@GlobalTransactional</p>
<p>普通方法：</p>
<p>@Transactional</p>
<hr>
<h1 id="十一、Oracle数据库-undo-log"><a href="#十一、Oracle数据库-undo-log" class="headerlink" title="十一、Oracle数据库 undo_log"></a>十一、Oracle数据库 undo_log</h1><p>CREATE TABLE undo_log (<br>id NUMBER(19) NOT NULL,<br>branch_id NUMBER(19) NOT NULL,<br>xid VARCHAR2(100) NOT NULL,<br>context VARCHAR2(128) NOT NULL,<br>rollback_info BLOB NOT NULL,<br>log_status NUMBER(10) NOT NULL,<br>log_created DATE NOT NULL,<br>log_modified DATE NOT NULL,<br>ext VARCHAR2(100),<br>CONSTRAINT pk_undo_log PRIMARY KEY (id)<br>);</p>
<hr>
<h1 id="十二、企业级避坑指南"><a href="#十二、企业级避坑指南" class="headerlink" title="十二、企业级避坑指南"></a>十二、企业级避坑指南</h1><ol>
<li>不支持复杂SQL</li>
<li>不支持MP批量操作</li>
<li>Feign必须检查返回值</li>
<li>每个业务库必须有 undo_log</li>
<li>AT模式入口必须使用 GlobalTransactional</li>
<li>Oracle建议驱动19+</li>
<li>Druid建议1.2.20+</li>
<li>异常不能吞</li>
<li>不支持事务嵌套</li>
<li>低版本Seata序列化问题严重</li>
</ol>
<hr>
<h1 id="十三、企业部署架构建议"><a href="#十三、企业部署架构建议" class="headerlink" title="十三、企业部署架构建议"></a>十三、企业部署架构建议</h1><p>Nacos集群<br>MySQL主从<br>Seata集群<br>Docker部署<br>日志集中收集</p>
<hr>
<h1 id="十四、生产环境建议"><a href="#十四、生产环境建议" class="headerlink" title="十四、生产环境建议"></a>十四、生产环境建议</h1><p>开启restart=always<br>开启日志挂载<br>禁止使用latest版本<br>配置独立数据库<br>使用内网IP注册</p>
<hr>
]]></content>
      <categories>
        <category>中间件实战</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Seata</tag>
        <tag>分布式事务</tag>
        <tag>微服务中间件</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux笔记</title>
    <url>/2023/07/25/Linux/</url>
    <content><![CDATA[<h1 id="安装虚拟化组"><a href="#安装虚拟化组" class="headerlink" title="安装虚拟化组"></a>安装虚拟化组</h1><h3 id="安装图形化界面虚拟机管理工具"><a href="#安装图形化界面虚拟机管理工具" class="headerlink" title="安装图形化界面虚拟机管理工具"></a>安装图形化界面虚拟机管理工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum groupinstall <span class="string">&#x27;Virtualization Host&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="启动虚拟化服务"><a href="#启动虚拟化服务" class="headerlink" title="启动虚拟化服务"></a>启动虚拟化服务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install virt-manager</span><br></pre></td></tr></table></figure>
<h3 id="Web管理界面"><a href="#Web管理界面" class="headerlink" title="Web管理界面"></a>Web管理界面</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl start libvirtd.service</span><br><span class="line">$ systemclt start cockpit.service</span><br></pre></td></tr></table></figure>
<h1 id="配置网卡"><a href="#配置网卡" class="headerlink" title="配置网卡"></a>配置网卡</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nmtui 图形化工具</span><br><span class="line">$ /etc/sysconfig/network-scripts/ifcfg-enp1s0 网卡配置文件</span><br><span class="line">$ nmcli con modify enp1s0 ipv4.method me</span><br><span class="line">$ nmcli con up enp1s0启用网卡配置</span><br></pre></td></tr></table></figure>
<p>w查看登录信息<br>Ss -ant查看链接信息<br>Ss -at<br>Ss -atu<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /etc/resolv.conf  dns记录文件 网卡会覆盖</span><br><span class="line">$ /etc/hostname修改主机名</span><br><span class="line">$ /etc/hosts dns解析文件</span><br></pre></td></tr></table></figure><br>route -n查询网关<br>主机名 计算机名<br>Fqdn  web-server.abc.com<br>Netbiosname.  Web-server<br>nmcli con show 查看<br>nmcli device status 查看网卡状态</p>
<h1 id="安装软件包-chrony"><a href="#安装软件包-chrony" class="headerlink" title="安装软件包 chrony"></a>安装软件包 chrony</h1><h3 id="查看时钟同步状态"><a href="#查看时钟同步状态" class="headerlink" title="查看时钟同步状态"></a>查看时钟同步状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chronyc sources -v</span><br></pre></td></tr></table></figure>
<h3 id="搭建内网Ntp服务器"><a href="#搭建内网Ntp服务器" class="headerlink" title="搭建内网Ntp服务器"></a>搭建内网Ntp服务器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/chrony.conf 修改配置文件</span><br><span class="line">$ firewall-cmd. --add-service=ntp 防火墙放行ntp服务</span><br></pre></td></tr></table></figure>
<p>修改时区<br>timedatectl. Set-timezone. Asia/Shanghai<br>           List-timezone  查询<br>Timedatectl. Set-ntp. true/false 开启互联网校准<br>Date -s. 修改时间</p>
<p>Yum list 查询仓库里所有软件包及其状态</p>
<p>rpm -i 安装 v查看安装信息 h显示进度<br>rpm -q查询<br>rpm -e删除<br>过滤<br>| grep 名字<br>查询某个文件属于某个rpm包<br>rpm -qa<br>Net-tools<br>Bash-c<em><br>Vim-e</em></p>
<h1 id="磁盘分区"><a href="#磁盘分区" class="headerlink" title="磁盘分区"></a>磁盘分区</h1><p>\1. /boot. 1g<br>\2. Swap.  2 Ram<br>\3. /.  All</p>
<h1 id="ssh配置"><a href="#ssh配置" class="headerlink" title="ssh配置"></a>ssh配置</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /etc/ssh/sshd_config</span><br><span class="line">$ Port 22</span><br><span class="line">$ Permitrootlogin <span class="built_in">yes</span> 允许 root远程登录 no禁止</span><br></pre></td></tr></table></figure>
<h3 id="关闭selinux安全插件"><a href="#关闭selinux安全插件" class="headerlink" title="关闭selinux安全插件"></a>关闭selinux安全插件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>
<h3 id="使用秘钥登陆"><a href="#使用秘钥登陆" class="headerlink" title="使用秘钥登陆"></a>使用秘钥登陆</h3><p>客户端生成秘钥文件  公钥加密（非对称加密）公钥，私钥</p>
<p>客户端<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen 生成公钥</span><br><span class="line">上传公钥到目标服务器的root账号</span><br><span class="line">$ ssh-copy-id 主机</span><br></pre></td></tr></table></figure></p>
<p>scp 文件 主机:位置<br>SCP -R 文件夹</p>
<h1 id=""><a href="#" class="headerlink" title=" "></a> </h1><h1 id="搭建DHCP服务器"><a href="#搭建DHCP服务器" class="headerlink" title="搭建DHCP服务器"></a>搭建DHCP服务器</h1><h3 id="安装dhcp软件包"><a href="#安装dhcp软件包" class="headerlink" title="安装dhcp软件包"></a>安装dhcp软件包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install dhcp-server</span><br><span class="line">修改配置文件 </span><br><span class="line">$ vim /etc/DHCP/dhcpd.conf</span><br></pre></td></tr></table></figure>
<p>10yy复制<br>P粘贴</p>
<p>查看磁盘<br>fdisk -l<br>lsblk<br>分区工具<br>fdisk交互式分区<br>n p w<br>parted 可交互</p>
<p>Parted 磁盘<br>Print打印查看<br>Mkpart<br>Name 名字<br>类型<br>起始 上一个磁盘的终止<br>终止 起始加分区大小<br>quit 退出<br>非交互式<br>parted 磁盘 mkpart 名字 起始 终止</p>
<p>RMB<br>Parted 磁盘 mklabel msdos<br>Parted 磁盘 rm 分区 删除分区<br>Parted 磁盘 mkpart 主/扩 格式 起始 终止<br>对分区进行格式化</p>
<p>ext4<br>Xfs<br>mkfs -t 格式 磁盘<br>mkfs.格式 磁盘<br>如果硬盘是Ada 插入U盘 设备名为 sdb<br>mount | tail -n 数字 查看文件的最后几行<br>lsblk -f 查看挂载<br>开机自动挂载<br>/etc/fstab<br>设备名建议使用UUID<br>blkid 磁盘 查看UUID<br>lsblk _f 查看UUID<br>udevadm settle 更新文件 rhel8<br>Parts -a 磁盘 更新文件. rhel7之前</p>
<p>扩充交换分区<br>mkswap 磁盘 格式化为swap类型<br>挂载为了swap空间<br>swapon 磁盘<br>swapon -s 查看<br>swapoff 卸载挂载点</p>
<p>dd if=/dev/zero of=/ten/swap1 bs=1M count=2048 复制磁盘块为文件<br>格式化<br>挂载</p>
<p>Man 命令 查看命令手册 </p>
<h1 id="搭建ftp服务器"><a href="#搭建ftp服务器" class="headerlink" title="搭建ftp服务器"></a>搭建ftp服务器</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install vsftpd -y</span><br><span class="line"> 修改FTP配置文件</span><br><span class="line">$ /etc/vsftpd/vsftpd.conf</span><br><span class="line"><span class="variable">$anonymous_enable</span>=<span class="built_in">yes</span></span><br><span class="line"> 启动FTP服务 开机自启</span><br><span class="line"><span class="variable">$systemctl</span> <span class="built_in">enable</span> vsftpd.service --now</span><br><span class="line"> Ftp 默认家目录 匿名访问</span><br><span class="line">$ /var/ftp</span><br><span class="line">默认命令行下是主动FTP 21 20建立传输</span><br><span class="line">被动高端端口</span><br><span class="line">限制FTP被动端口范围</span><br><span class="line">Pasv_min_port=10000</span><br><span class="line">Pasv_max_port=11000</span><br><span class="line">Ss -ant查看 </span><br></pre></td></tr></table></figure>
<h1 id="LVM-逻辑卷管理"><a href="#LVM-逻辑卷管理" class="headerlink" title="LVM  逻辑卷管理"></a>LVM  逻辑卷管理</h1><p>传统的磁盘分区  分区固定后不能更改</p>
<h3 id="将磁盘，分区转换为PV逻辑卷"><a href="#将磁盘，分区转换为PV逻辑卷" class="headerlink" title="将磁盘，分区转换为PV逻辑卷"></a>将磁盘，分区转换为PV逻辑卷</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ PVcreate 磁盘</span><br><span class="line">$ Pvs. Pvdisplay 磁盘 查看信息</span><br></pre></td></tr></table></figure>
<h3 id="将物理卷组合成卷组-VG"><a href="#将物理卷组合成卷组-VG" class="headerlink" title="将物理卷组合成卷组 VG"></a>将物理卷组合成卷组 VG</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vgcreate 名字 磁盘</span><br><span class="line">$ vgs. Vgdispaly 磁盘 查看</span><br><span class="line">$ VGremove 名称 删除卷组</span><br><span class="line">$ -s定义块大小</span><br><span class="line"></span><br><span class="line">Pe的尺寸可以更改</span><br></pre></td></tr></table></figure>
<h3 id="创建lv-逻辑卷"><a href="#创建lv-逻辑卷" class="headerlink" title="创建lv 逻辑卷"></a>创建lv 逻辑卷</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lvcreate -n 名字 -L 大小/-l 多少个块 卷组</span><br><span class="line">$ lvextend -L +尺寸 逻辑卷 扩展逻辑卷</span><br><span class="line">将扩展的lv与挂载点 同步尺寸</span><br><span class="line">xfs_growfs 挂载点</span><br><span class="line">Resize2fs 逻辑卷 ext4同步</span><br><span class="line">Vgextend vg pv扩展卷组</span><br></pre></td></tr></table></figure>
<h1 id="dns服务器"><a href="#dns服务器" class="headerlink" title="dns服务器"></a>dns服务器</h1><h3 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install <span class="built_in">bind</span>. bind-utils </span><br><span class="line">$ /etc/named.conf</span><br><span class="line">UDP53客户机找服务</span><br><span class="line">Tcp53服务器找服务器</span><br><span class="line"></span><br><span class="line">添加区域</span><br><span class="line">zone “ABC.com”IN&#123;</span><br><span class="line">      <span class="built_in">type</span> master;</span><br><span class="line">      File <span class="string">&quot;abc.com.zone&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$ /var/named/</span><br></pre></td></tr></table></figure>
<p>mount -o loop 文件 挂载本地文件<br>＞覆盖 ＞＞重定向<br>开机自动挂载 defaults.loop<br>给web启用 ssl 使用数字证书<br>Yum install mod_ssl</p>
<h1 id="搭建多个web站点-虚拟主机"><a href="#搭建多个web站点-虚拟主机" class="headerlink" title="搭建多个web站点 虚拟主机"></a>搭建多个web站点 虚拟主机</h1><p>Apache 配置文件 /etc/httpd<br>conf 主配置文件 conf.d辅配置文件<br>/usr/share/doc/httpd配置文件模板<br>httpd-vhosts.conf 虚拟主机模板</p>
<p>动态网站<br>asp asp.net php jsp Python 等开发<br>小型机 IBM Aix<br>      Sun solris Oracle 甲骨文<br>      Hp hp-unix</p>
<p>挂接数据库 mysql mariadb<br>mariadb-server<br>如果需要，可以做安全初始化配置<br>MySQL_secure_installation<br>清除历史命令 history -c<br>unzip 文件 -d 目录</p>
<p>Chmod o+w config/ -R<br>data/ -R<br>uc_client<br>Uc_server<br>软件包 php-mysqlnd<br>Php-xml</p>
<p>firewall-cmd.  —list-all  查看防火墙规则<br>firewall-cmd —list-all<br>firewalld.richlanguage富规则<br>firewall-cmd —add-service=服务  —permanent. 写入配置文件</p>
]]></content>
  </entry>
  <entry>
    <title>docker部署mqtt</title>
    <url>/2026/02/06/mqtt/</url>
    <content><![CDATA[<p>Docker 部署 MQTT服务器(EMQX)</p>
<p>m0_46601820</p>
<p>于 2023-12-14 09:10:40 发布</p>
<p>阅读量1.4k<br> 收藏 12</p>
<p>点赞数 10<br>文章标签： docker 服务器 容器<br>版权<br>1.拉取镜像</p>
<h1 id="拉取最新版本"><a href="#拉取最新版本" class="headerlink" title="拉取最新版本"></a>拉取最新版本</h1><p>docker pull emqx/emqx:latest</p>
<h1 id="也可以拉取指定版本"><a href="#也可以拉取指定版本" class="headerlink" title="也可以拉取指定版本"></a>也可以拉取指定版本</h1><p>docker pull emqx/emqx:v4.0.0<br>2.创建临时容器</p>
<p>docker run -d —name emqx -p 1883:1883 -p 8083:8083 -p 8084:8084 -p 8883:8883 -p 18083:18083 emqx/emqx:latest<br>端口：</p>
<p>1883：MQTT协议端口<br>8083：WebSocket协议端口<br>8084：HTTP协议端口<br>8883：MQTT over SSL协议端口<br>18083：EMQX Dashboard Web管理界面端口<br> 3.创建文件挂载目录</p>
<p>mkdir -p /app/emqx/etc /app/emqx/lib /app/emqx/data /app/emqx/log<br>4.从容器内复制配置文件到挂载目录下</p>
<p>docker cp emqx:/opt/emqx/etc /app/emqx/etc<br> 5.强制删除docker 容器</p>
<p>docker rm -f emqx<br>6.运行并挂载文件代码</p>
<p>docker run -d \<br>—restart=always \<br>—name emqx \<br>-p 1883:1883 \<br>-p 8883:8883 \<br>-p 8083:8083 \<br>-p 8084:8084 \<br>-p 8081:8081 \<br>-p 18083:18083 \<br>-v /app/emqx/etc:/opt/emqx/etc \<br>emqx/emqx:latest<br>7.登录EMQX 内置的管理控制台 </p>
<p><a href="http://localhost:18083/">http://localhost:18083/</a></p>
<p>默认用户 admin，默认密码 public</p>
<p>8.设置客户端认证</p>
<p>在 EMQX Dashboard 页面，点击左侧导航栏的访问控制 -&gt; 认证，在随即打开的认证页面，单击创建，依次选择认证方式为 Password-Based，数据源为 Built-in Database，进入配置参数</p>
<p>Docker | EMQX 文档</p>
<p>使用Emqx5 | FastBee文档<br>————————————————</p>
<pre><code>                        版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。
</code></pre><p>原文链接：<a href="https://blog.csdn.net/m0_46601820/article/details/134969551">https://blog.csdn.net/m0_46601820/article/details/134969551</a></p>
]]></content>
  </entry>
  <entry>
    <title>docker命令笔记</title>
    <url>/2026/02/06/docker%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>docker version        # 显示docker的版本信息<br>docker info              # 显示docker的系统信息，包括镜像和容器的数量<br>docker 命令 —help         # 帮助命令<br>docker images    #查看镜像<br>docker search    #搜索镜像<br>docker pull    #下载镜像<br>docker pull  mysql:5.7    #指定版本下载<br>docker rmi     #删除镜像<br>[root@JWei_0124 //]# docker rmi -f 镜像id                    # 删除指定的镜像<br>[root@JWei_0124 //]# docker rmi -f 镜像id 镜像id 镜像id    # 删除多个镜像（空格分隔）<br>[root@JWei_0124 //]# docker rmi -f $(docker images -aq)    # 删除全部的镜像<br>docker run [可选参数] image</p>
<h1 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h1><p>—name=”name”        容器名字：用来区分容器<br>-d                    后台方式运行：相当于nohup<br>-it                    使用交互式运行：进入容器查看内容<br>-p                    指定容器的端口（四种方式）小写字母p<br>    -p ip:主机端口：容器端口<br>    -p 主机端口：容器端口<br>    -p 容器端口<br>    容器端口<br>-P                     随机指定端口（大写字母P）</p>
<p>docker ps         #列出当前正在运行的容器</p>
<h1 id="命令参数可选项"><a href="#命令参数可选项" class="headerlink" title="命令参数可选项"></a>命令参数可选项</h1><p>-a        # 列出当前正在运行的容器+历史运行过的容器<br>-n=?    # 显示最近创建的容器（可以指定显示几条，比如-n=1）<br>-q        # 只显示容器的编号</p>
<p>docker run -it centos /bin/bash #交互式进入<br>docker rm 容器ID    #删除容器（不能删除正在运行的容器）<br>docker rm -f     #强制删除<br>docker ps -a -q|xargs docker rm     #删除所有容器<br>docker start 容器id        # 启动容器<br>docker restart 容器id    # 重启容器<br>docker stop 容器id        # 停止当前正在运行的容器<br>docker kill 容器id        # 强制停止当前容器</p>
<p>docker logs -tf —tail 容器id</p>
<p>-tf                        # 显示日志<br>—tail number    # 要显示的日志条数</p>
<p>查看容器中进程的信息<br>docker top id<br>查看镜像的元数据<br>docker inspect id<br>进入当前正在运行的容器<br>docker exec -it 容器id /bin/bash</p>
<p>从容器内拷贝文件到主机<br>docker cp 容器id:容器内路径 目的主机的路径</p>
<h1 id="如何确定是具名挂载，还是匿名挂载，还是指定路径挂载"><a href="#如何确定是具名挂载，还是匿名挂载，还是指定路径挂载" class="headerlink" title="如何确定是具名挂载，还是匿名挂载，还是指定路径挂载"></a>如何确定是具名挂载，还是匿名挂载，还是指定路径挂载</h1><p>-v 容器内的路径                # 匿名挂载<br>-v 卷名:容器内的路径        # 具名挂载<br>-v /宿主机路径:容器内路径    # 指定路径挂载</p>
<h1 id="提交容器成为一个新的副本"><a href="#提交容器成为一个新的副本" class="headerlink" title="提交容器成为一个新的副本"></a>提交容器成为一个新的副本</h1><p>docker commit</p>
<h1 id="命令和git原理类似"><a href="#命令和git原理类似" class="headerlink" title="命令和git原理类似"></a>命令和git原理类似</h1><p>docker commit -m=”提交的描述信息” -a=”作者” 容器id 目标镜像名:[TAG]</p>
<h1 id="我们直接启动的命令—net-bridge（这个就是我们的docker0）；默认带上这个参数的，以下两种启动方式效果一致。"><a href="#我们直接启动的命令—net-bridge（这个就是我们的docker0）；默认带上这个参数的，以下两种启动方式效果一致。" class="headerlink" title="我们直接启动的命令—net bridge（这个就是我们的docker0）；默认带上这个参数的，以下两种启动方式效果一致。"></a>我们直接启动的命令—net bridge（这个就是我们的docker0）；默认带上这个参数的，以下两种启动方式效果一致。</h1><p>docker run -d -P —name tomcat01 tomcat<br>docker run -d -P —name tomcato1 —het bridge tomcat</p>
<h1 id="docker0特点：默认，域名不能访问，—1ink可以打通连接！"><a href="#docker0特点：默认，域名不能访问，—1ink可以打通连接！" class="headerlink" title="docker0特点：默认，域名不能访问，—1ink可以打通连接！"></a>docker0特点：默认，域名不能访问，—1ink可以打通连接！</h1><h1 id="我们可以自定义一个网络！"><a href="#我们可以自定义一个网络！" class="headerlink" title="我们可以自定义一个网络！"></a>我们可以自定义一个网络！</h1><p>[root@iZbp13qr3mm4ucsjumrlgqZ ~]# docker network create —driver bridge —subnet 192.168.0.0/16 —gateway 192.168.0.1 mynet<br>[root@iZbp13qr3mm4ucsjumrlgqZ ~]# docker network ls<br>NETWORK ID     NAME      DRIVER    SCOPE<br>7254ffccbdf5   bridge    bridge    local<br>45610891738f   host      host      local<br>266acd66473c   mynet     bridge    local<br>7795cbc2686c   none      null      local</p>
]]></content>
  </entry>
  <entry>
    <title>git-jenkins-harbor-k8s部署笔记</title>
    <url>/2026/02/06/git-jenkins-harbor-k8s%E9%83%A8%E7%BD%B2%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>1.3 软硬件环境<br>角色    主机名    ip地址    备注<br>master    k8s-master    192.168.163.151<br>k8s主节点、8核CPU、4GB(CD)</p>
<p>node    k8s-node1    192.168.163.152<br>k8s从节点、8核CPU、4GB</p>
<p>node    k8s-node2    192.168.163.153<br>k8s从节点、8核CPU、4GB</p>
<p>Gitlab+Jenkins+Docker    jenkins    192.168.163.155<br> 8核CPU、12GB，Gitlab最少需要4G(CI)</p>
<p>docker镜像仓库:harbor    harbor    192.168.163.156<br>8核CPU、4GB</p>
<p>软件    版本<br>docker    26.1.3<br>k8s    1.22.2<br>harbor    2.0.6<br>Jenkins    2.457(尽量别用latest版本安装 可能导致插件安装失败)<br>gitlab    10.7.5<br>二、环境准备<br>在所有节点操作</p>
<p>2.1 关闭NetworkManager<br>NetworkManager会和network启动是发生冲突，导致network启动失败，不能远程访问虚拟机；</p>
<p>systemctl stop NetworkManager                #临时关闭<br>systemctl disable NetworkManager             #永久关闭网络管理命令<br>systemctl start network.service              #开启网络服务<br>2.2 设置静态ip<br>  2.2.1查看网络配置</p>
<p>ifconfig #查看网络配置<br>2.2.2 修改网络配置文件</p>
<p>vi /etc/sysconfig/network-scripts/ifcfg-ens33<br>1）选择动态分配或者静态分配</p>
<p>BOOTPROTO=static    #dhcp：自动分配ip ，static：静态ip<br>2）开启自动打开网卡</p>
<p>ONBOOT=yes     #开启启动必须是yes</p>
<p>TYPE=Ethernet<br>PROXY_METHOD=none<br>BROWSER_ONLY=no<br>BOOTPROTO=static    #dhcp：自动分配ip ，static：静态ip<br>DEFROUTE=yes<br>IPV4_FAILURE_FATAL=no<br>IPV6INIT=yes<br>IPV6_AUTOCONF=yes<br>IPV6_DEFROUTE=yes<br>IPV6_FAILURE_FATAL=no<br>IPV6_ADDR_GEN_MODE=stable-privacy<br>NAME=ens33<br>UUID=9c922cc8-b3ed-419a-88bd-6fd756e04880<br>DEVICE=ens33<br>ONBOOT=yes  #开启启动必须是yes<br>IPADDR=192.168.163.152 #静态ip<br>NETMASK=255.255.255.0  #<br>GATEWAY=192.168.163.2  #网关<br>DNS1=192.168.163.0   #DNS<br>DNS2=114.114.114.114<br>2.2.3重启服务</p>
<p>systemctl restart network<br>2.2.4查看网络状态</p>
<p>systemctl status network.service</p>
<h3 id="2-3-修改主机名"><a href="#2-3-修改主机名" class="headerlink" title="2.3 修改主机名"></a>2.3 修改主机名</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master <span class="comment">#k8s-master 为主机名称</span></span><br></pre></td></tr></table></figure>
<h3 id="2-3-所有机器关闭防火墙"><a href="#2-3-所有机器关闭防火墙" class="headerlink" title="2.3 所有机器关闭防火墙"></a>2.3 所有机器关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld	<span class="comment">#关闭</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld		<span class="comment">#开机不自启</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl status firewalld		<span class="comment">#查看状态</span></span><br></pre></td></tr></table></figure>
<h3 id="2-4-所有机器关闭selinux"><a href="#2-4-所有机器关闭selinux" class="headerlink" title="2.4 所有机器关闭selinux"></a>2.4 所有机器关闭selinux</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> systemctl status firewalld</span><br></pre></td></tr></table></figure>
<h3 id="2-5-所有机器关闭swap"><a href="#2-5-所有机器关闭swap" class="headerlink" title="2.5 所有机器关闭swap"></a>2.5 所有机器关闭swap</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">swapoff -a <span class="comment"># 临时关闭</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab  <span class="comment">#永久关闭</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">swapon -s <span class="comment">#查看swapon分区</span></span><br></pre></td></tr></table></figure>
<p>2.6 为所有节点安装docker<br>yum install wget.x86_64 -y<br>rm -rf /etc/yum.repos.d/*<br>wget -O /etc/yum.repos.d/centos7.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo">http://mirrors.aliyun.com/repo/Centos-7.repo</a><br>wget -O /etc/yum.repos.d/epel-7.repo <a href="http://mirrors.aliyun.com/repo/epel-7.repo">http://mirrors.aliyun.com/repo/epel-7.repo</a><br>wget -O /etc/yum.repos.d/docker-ce.repo <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a><br>yum install docker-ce-20.10.11 -y<br>systemctl start docker<br>systemctl enable docker<br>docker version</p>
<p>配置docker加速器</p>
<p> mkdir -p /etc/docker<br> tee /etc/docker/daemon.json &lt;&lt;-‘EOF’<br>{<br>  “registry-mirrors”: [“<a href="https://2tefyfv7.mirror.aliyuncs.com">https://2tefyfv7.mirror.aliyuncs.com</a>“]<br>}<br>EOF<br> systemctl daemon-reload<br> systemctl restart docker<br>三、部署k8s集群<br>3.1 添加主机名与ip的对应关系（k8s-master、k8s-node1、k8s-node2）<br>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br>192.168.163.151 k8s-master<br>192.168.163.152 k8s-node1<br>192.168.163.153 k8s-node2<br>EOF</p>
<p>source /etc/profile</p>
<p>3.2 将桥接的ipv4流量传递到iptables的链（k8s-master、k8s-node1、k8s-node2）<br>cat &gt;&gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF<br> net.bridge.bridge-nf-call-ip6tables = 1<br> net.bridge.bridge-nf-call-iptables = 1<br>EOF</p>
<p>3.3 安装kubeadm、kubelet、kubectl（k8s-master、k8s-node1、k8s-node2）<br>cat &lt;<EOF > /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=<a href="https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/">https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</a><br>enabled=1<br>gpgcheck=1<br>repo_gpgcheck=1<br>gpgkey=<a href="https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg">https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</a> <a href="https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg">https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</a><br>EOF<br>yum install kubelet-1.22.2 kubeadm-1.22.2 kubectl-1.22.2 -y<br>systemctl enable kubelet &amp;&amp; systemctl start kubelet<br>kubectl version</p>
<p>3.4 修改docker的配置（k8s-master、k8s-node1、k8s-node2）  </p>
<h1 id="镜像加速-registry-mirrors"><a href="#镜像加速-registry-mirrors" class="headerlink" title="镜像加速 registry-mirrors"></a>镜像加速 registry-mirrors</h1><p>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF<br>{<br>  “exec-opts”: [“native.cgroupdriver=systemd”],<br>  “registry-mirrors”: [“<a href="https://2tefyfv7.mirror.aliyuncs.com">https://2tefyfv7.mirror.aliyuncs.com</a>“]<br>}<br>EOF<br>systemctl daemon-reload<br>systemctl restart docker.service<br>systemctl restart kubelet.service<br>systemctl status kubelet.service</p>
<p>这里从节点的kubelet.service状态报code=exited, status=1/FAILURE是正常的 集群没有初始化导致的</p>
<p>3.5 部署master节点（主节点k8s-master）<br>3.5.1 集群初始化<br>kubeadm init \<br>—apiserver-advertise-address=192.168.71.129 \<br>—image-repository registry.aliyuncs.com/google_containers \<br>—kubernetes-version v1.23.0 \<br>—control-plane-endpoint k8s-master \<br>—service-cidr=172.16.0.0/16 \<br>—pod-network-cidr=10.244.0.0/16<br>这段命令是用于将一个工作节点（worker node）加入到已存在的 Kubernetes 集群中的过程。</p>
<p>kubeadm init 是用来初始化 Kubernetes 集群的命令。下面是一些常用的参数及其说明：</p>
<p>—apiserver-advertise-address: 指定用于通告的 API 服务器的 IP 地址。</p>
<p>—apiserver-bind-port: 指定 API 服务器绑定的端口。</p>
<p>—control-plane-endpoint: 指定控制平面的端口。</p>
<p>—image-repository: 设置 Kubernetes 镜像仓库的地址。</p>
<p>—kubernetes-version: 设置 Kubernetes 版本。</p>
<p>—pod-network-cidr: 设置 Pod 网络的 CIDR 范围。</p>
<p>—service-cidr: 设置服务的 CIDR 范围。</p>
<p>1).遇到报错： </p>
<p>2).解决办法：关闭swap</p>
<p> swapoff -a # 临时关闭<br> sed -ri ‘s/.<em>swap.</em>/#&amp;/‘ /etc/fstab  #永久关闭<br>1).遇到报错：</p>
<p>Here is one example how you may list all Kubernetes containers running in docker:</p>
<pre><code>            - &#39;docker ps -a | grep kube | grep -v pause&#39;
            Once you have found the failing container, you can inspect its logs with:
            - &#39;docker logs CONTAINERID&#39;
</code></pre><p>error execution phase wait-control-plane: couldn’t initialize a Kubernetes cluster<br>To see the stack trace of this error execute with —v=5 or higher<br>2).解决办法：</p>
<p>rm -rf /etc/containerd/config.toml<br>systemctl restart containerd<br> 如果初始化失败，可以重新初始化</p>
<p>kubeadm reset<br>此命令将删除当前集群的状态信息，并使其回到初始状态</p>
<p>初始化成功</p>
<p>记下红框中内容，添加节点时需要</p>
<p>3.5.2 按照指示执行<br>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br>初始化时 该命令有输出</p>
<p>3.5.3 查看kubelet.service状态<br>systemctl status kubelet.service</p>
<p>3.5.4 查看节点状态为notready<br>kubectl get nodes</p>
<p>3.5.5 安装网络插件<br>官方文档：<a href="https://github.com/flannel-io/flannel">https://github.com/flannel-io/flannel</a></p>
<h1 id="最好手动提前拉取所需镜像"><a href="#最好手动提前拉取所需镜像" class="headerlink" title="最好手动提前拉取所需镜像"></a>最好手动提前拉取所需镜像</h1><p>docker pull quay.io/coreos/flannel:v0.14.0<br>wget <a href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a><br>kubectl apply -f kube-flannel.yml<br>kubectl get pods —all-namespaces</p>
<p>3.5.6 添加node节点<br>在k8s-node1和k8s-node1节点执行</p>
<p>docker pull quay.io/coreos/flannel:v0.14.0<br>kubeadm join k8s-master:6443 —token yt11th.b5wzq4lkjxcsljpg \<br>    —discovery-token-ca-cert-hash sha256:f36824a14f1acb9413246e8f5f0cdf5f6060066f7e4eec6d27edd69004499f9f</p>
<p>在主节点k8s-master查看节点状态为notready </p>
<p> 四、部署Gitlab（192.168.163.155）<br>4.1 配置docker加速器<br> mkdir -p /etc/docker<br> tee /etc/docker/daemon.json &lt;&lt;-‘EOF’<br>{<br>  “registry-mirrors”: [“<a href="https://2tefyfv7.mirror.aliyuncs.com">https://2tefyfv7.mirror.aliyuncs.com</a>“]<br>}<br>EOF<br> systemctl daemon-reload<br> systemctl restart docker</p>
<p>4.2 安装并配置Gitlab<br>docker pull beginor/gitlab-ce</p>
<p>4.2.1 创建共享卷目录<br>mkdir -p /data/gitlab/etc/ /data/gitlab/log/ /data/gitlab/data<br>chmod 777 /data/gitlab/etc/ /data/gitlab/log/ /data/gitlab/data/<br>4.2.2 创建 gitlab 容器<br>docker run -itd —name=gitlab —restart=always —privileged=true   -p 8443:443  -p 80:80 -p 222:22 -v  /data/gitlab/etc:/etc/gitlab -v  /data/gitlab/log:/var/log/gitlab -v  /data/gitlab/data:/var/opt/gitlab  beginor/gitlab-ce<br>docker ps<br> 切记:这里的端口要设置成80，要不push项目会提示没有报错，如果宿主机端口被占用，需要把这个端口腾出来</p>
<p>4.2.3 关闭容器修改配置文件<br>docker stop gitlab<br>cat /data/gitlab/etc/gitlab.rb |grep external_url<br>sed -i “/external_url ‘GENERATED_EXTERNAL_URL’/a external_url\t’<a href="http://192.168.163.155">http://192.168.163.155</a>‘ “  /data/gitlab/etc/gitlab.rb<br>cat /data/gitlab/etc/gitlab.rb |grep external_url<br> external_url ‘<a href="http://192.168.163.155’">http://192.168.163.155’</a></p>
<p> gitlab_rails[‘gitlab_ssh_host’] = ‘192.168.163.155’’</p>
<p>cat /data/gitlab/etc/gitlab.rb |grep gitlab_ssh_host<br>sed -i “/gitlab_ssh_host/a gitlab_rails[‘gitlab_ssh_host’] = ‘192.168.163.155’ “  /data/gitlab/etc/gitlab.rb<br>cat /data/gitlab/etc/gitlab.rb |grep gitlab_ssh_host</p>
<p>gitlab_rails[gitlab_shell_ssh_port] = 222</p>
<p>cat /data/gitlab/etc/gitlab.rb | grep gitlab_shell_ssh<br>sed -i “/gitlab_shell_ssh_port/a gitlab_rails[‘gitlab_shell_ssh_port’] = 222” /data/gitlab/etc/gitlab.rb<br>cat /data/gitlab/etc/gitlab.rb | grep gitlab_shell_ssh<br>vim /data/gitlab/data/gitlab-rails/etc/gitlab.yml</p>
<p>4.2.4 修改完配置文件之后。直接启动容器<br>docker start gitlab<br>docker ps<br>在宿主机所在的物理机访问，<a href="http://192.168.163.155/">http://192.168.163.155/</a> ，会自动跳转到修改密码(root用户),如果密码设置的没有满足一定的复杂性，则会报500，需要从新设置</p>
<p>4.2.5 新建SSH密钥<br>  1.进入gitlab容器</p>
<p>docker exec -it gitlab /bin/sh</p>
<p>  2.生成密钥</p>
<p>ssh-keygen<br>一路回车就可以完成 创建SSH 密钥，可以看到 ~/.ssh目录下生成了 id_rsa 和 id_rsa.pub 两个文件</p>
<p>3.查看密钥</p>
<p>cat ~/.ssh/id_rsa.pub</p>
<p>4.gitlab配置密钥</p>
<p> 5.推出容器</p>
<p>exit</p>
<p>五、部署harbor（192.168.163.156）<br>5.1 安装docker-compose<br>yum install -y docker-compose<br>配置docker加速器</p>
<p>mkdir -p /etc/docker<br>tee /etc/docker/daemon.json &lt;&lt;-‘EOF’<br>{<br>  “registry-mirrors”: [“<a href="https://2tefyfv7.mirror.aliyuncs.com">https://2tefyfv7.mirror.aliyuncs.com</a>“]<br>}<br>EOF<br>systemctl daemon-reload<br>systemctl restart docker<br>5.2 使用安装包安装 harbor<br>harbor安装包：harbor</p>
<p> 解压安装harbor</p>
<p>tar -zxvf harbor-offline-installer-v2.0.6.tgz<br>docker load -i harbor/harbor.v2.0.6.tar.gz</p>
<p>5.3 修改配置文件<br>cd harbor/<br>cp harbor.yml.tmpl harbor.yml<br>vim harbor.yml<br> harbor.yml：设置IP和用户名密码 注释写https</p>
<p>5.4 执行./prepare &amp;&amp; ./install.sh 初始化harbor<br>./prepare<br>./install.sh</p>
<p>[root@harbor ~]# cd harbor/<br>[root@harbor harbor]# cp harbor.yml.tmpl harbor.yml<br>[root@harbor harbor]# vim harbor.yml<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]# ./prepare<br>prepare base dir is set to /root/harbor<br>ERROR:root:Error: The protocol is https but attribute ssl_cert is not set<br>Error happened in config validation…<br>[root@harbor harbor]# ls<br>common  common.sh  harbor.v2.0.6.tar.gz  harbor.yml  harbor.yml.tmpl  input  install.sh  LICENSE  prepare<br>[root@harbor harbor]# prepare<br>bash: prepare: 未找到命令…<br>[root@harbor harbor]# ./prepare<br>prepare base dir is set to /root/harbor<br>Error happened in config validation…<br>ERROR:root:Error: The protocol is https but attribute ssl_cert is not set<br>[root@harbor harbor]# vim harbor.yml<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]# ./prepare<br>prepare base dir is set to /root/harbor<br>Error happened in config validation…<br>ERROR:root:Error: The protocol is https but attribute ssl_cert is not set<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]# vim harbor.yml<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]# clear<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]# ./prepare<br>prepare base dir is set to /root/harbor<br>WARNING:root:WARNING: HTTP protocol is insecure. Harbor will deprecate http protocol in the future. Please make sure to upgrade to https<br>Generated configuration file: /config/log/logrotate.conf<br>Generated configuration file: /config/log/rsyslog_docker.conf<br>Generated configuration file: /config/nginx/nginx.conf<br>Generated configuration file: /config/core/env<br>Generated configuration file: /config/core/app.conf<br>Generated configuration file: /config/registry/config.yml<br>Generated configuration file: /config/registryctl/env<br>Generated configuration file: /config/registryctl/config.yml<br>Generated configuration file: /config/db/env<br>Generated configuration file: /config/jobservice/env<br>Generated configuration file: /config/jobservice/config.yml<br>Generated and saved secret to file: /data/secret/keys/secretkey<br>Successfully called func: create_root_cert<br>Generated configuration file: /compose_location/docker-compose.yml<br>Clean up the input dir<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]#<br>[root@harbor harbor]# ./install.sh</p>
<p>[Step 0]: checking if docker is installed …</p>
<p>Note: docker version: 26.1.3</p>
<p>[Step 1]: checking docker-compose is installed …</p>
<p>Note: docker-compose version: 1.18.0</p>
<p>[Step 2]: loading Harbor images …<br>Loaded image: goharbor/notary-server-photon:v2.0.6<br>Loaded image: goharbor/clair-photon:v2.0.6<br>Loaded image: goharbor/clair-adapter-photon:v2.0.6<br>Loaded image: goharbor/harbor-portal:v2.0.6<br>Loaded image: goharbor/harbor-core:v2.0.6<br>Loaded image: goharbor/harbor-db:v2.0.6<br>Loaded image: goharbor/harbor-jobservice:v2.0.6<br>Loaded image: goharbor/redis-photon:v2.0.6<br>Loaded image: goharbor/notary-signer-photon:v2.0.6<br>Loaded image: goharbor/harbor-log:v2.0.6<br>Loaded image: goharbor/harbor-registryctl:v2.0.6<br>Loaded image: goharbor/trivy-adapter-photon:v2.0.6<br>Loaded image: goharbor/chartmuseum-photon:v2.0.6<br>Loaded image: goharbor/prepare:v2.0.6<br>Loaded image: goharbor/nginx-photon:v2.0.6<br>Loaded image: goharbor/registry-photon:v2.0.6</p>
<p>[Step 3]: preparing environment …</p>
<p>[Step 4]: preparing harbor configs …<br>prepare base dir is set to /root/harbor<br>WARNING:root:WARNING: HTTP protocol is insecure. Harbor will deprecate http protocol in the future. Please make sure to upgrade to https<br>Clearing the configuration file: /config/log/logrotate.conf<br>Clearing the configuration file: /config/log/rsyslog_docker.conf<br>Clearing the configuration file: /config/nginx/nginx.conf<br>Clearing the configuration file: /config/core/env<br>Clearing the configuration file: /config/core/app.conf<br>Clearing the configuration file: /config/registry/passwd<br>Clearing the configuration file: /config/registry/config.yml<br>Clearing the configuration file: /config/registryctl/env<br>Clearing the configuration file: /config/registryctl/config.yml<br>Clearing the configuration file: /config/db/env<br>Clearing the configuration file: /config/jobservice/env<br>Clearing the configuration file: /config/jobservice/config.yml<br>Generated configuration file: /config/log/logrotate.conf<br>Generated configuration file: /config/log/rsyslog_docker.conf<br>Generated configuration file: /config/nginx/nginx.conf<br>Generated configuration file: /config/core/env<br>Generated configuration file: /config/core/app.conf<br>Generated configuration file: /config/registry/config.yml<br>Generated configuration file: /config/registryctl/env<br>Generated configuration file: /config/registryctl/config.yml<br>Generated configuration file: /config/db/env<br>Generated configuration file: /config/jobservice/env<br>Generated configuration file: /config/jobservice/config.yml<br>Creating harbor-log … done<br>Generated configuration file: /compose_location/docker-compose.yml<br>Clean up the input dir</p>
<p>Creating harbor-db … done<br>Creating harbor-core … done<br>Creating network “harbor_harbor” with the default driver<br>Creating nginx … done<br>Creating harbor-portal …<br>Creating redis …<br>Creating registryctl …<br>Creating registry …<br>Creating harbor-db …<br>Creating harbor-core …<br>Creating harbor-jobservice …<br>Creating nginx …<br>✔ ——Harbor has been installed and started successfully.——<br>[root@harbor harbor]# </p>
<p>5.5 查看相关镜像<br>docker ps</p>
<p>5.6 访问测试<br> <a href="http://192.168.163.156">http://192.168.163.156</a></p>
<p>5.7 CI服务器的docker配置（jenkins:192.168.163.155）<br>这里因为我们要在192.168.163.155(CI服务器)上push镜像到192.168.163.156(私仓)，所有需要修改CI服务器上的Docker配置。</p>
<p>cat /etc/docker/daemon.json<br>vim /etc/docker/daemon.json</p>
<p>[root@jenkins ~]# cat /etc/docker/daemon.json<br>{<br>  “registry-mirrors”: [“<a href="https://2tefyfv7.mirror.aliyuncs.com">https://2tefyfv7.mirror.aliyuncs.com</a>“],<br>  “insecure-registries”: [“192.168.163.156”]<br>}<br>[root@jenkins ~]#<br>加载使其生效 </p>
<p>systemctl daemon-reload<br>systemctl restart docker<br> CI机器简单测试一下</p>
<p>docker login 192.168.163.156<br> 测试上传镜像</p>
<p>docker tag beginor/gitlab-ce 192.168.163.156/library/gitlab-ce #beginor/gitlab-ce为本地镜像 可以自定义<br>docker images<br>docker push 192.168.163.156/library/gitlab-ce</p>
<p>5.8 CD服务器的docker配置（k8s-master、k8s-node1、k8s-node2）<br>cat /etc/docker/daemon.json</p>
<p>vim /etc/docker/daemon.json<br>cat /etc/docker/daemon.json</p>
<p>加载使其生效 </p>
<p>systemctl daemon-reload<br>systemctl restart docker<br>CI机器简单测试一下</p>
<p>5.9 harbor开机启动<br>  编辑/lib/systemd/system/harbor.service</p>
<p>vim /lib/systemd/system/harbor.service<br>[Unit]<br>Description=Harbor<br>After=network.service docker.service systemd-networkd.service systemd-resolved.service<br>Requires=docker.service<br>Documentation=<a href="http://github.com/vmware/harbor">http://github.com/vmware/harbor</a></p>
<p>[Service]<br>Type=simple<br>Restart=on-failure<br>RestartSec=5<br>ExecStart=/usr/bin/docker-compose -f /root/harbor/docker-compose.yml up<br>ExecStop=/usr/bin/docker-compose -f /root/harbor/docker-compose.yml down</p>
<p>[Install]<br>WantedBy=multi-user.target</p>
<p>重载配置 </p>
<p>chmod 755 /lib/systemd/system/harbor.service<br>systemctl restart harbor<br>systemctl status harbor<br>systemctl enable harbor</p>
<p> 六、安装配置jenkins（jenkins:192.168.163.155）<br>6.1 镜像jenkins拉取<br>docker pull jenkins/jenkins:2.457</p>
<p>6.2 创建共享卷，修改所属组和用户,和容器里相同<br>mkdir /jenkins<br>chown 1000:1000 /jenkins</p>
<h1 id="这里为什么要改成-1000，是因为容器里是以-jenkins-用户的身份去读写数据，而在容器里jenkins-的-uid-是-1000"><a href="#这里为什么要改成-1000，是因为容器里是以-jenkins-用户的身份去读写数据，而在容器里jenkins-的-uid-是-1000" class="headerlink" title="这里为什么要改成 1000，是因为容器里是以 jenkins 用户的身份去读写数据，而在容器里jenkins 的 uid 是 1000"></a>这里为什么要改成 1000，是因为容器里是以 jenkins 用户的身份去读写数据，而在容器里jenkins 的 uid 是 1000</h1><p>6.3 创建 jenkins 容器<br>docker run -dit -p 8080:8080 -p 50000:50000 —name jenkins  —privileged=true —restart=always -v /jenkins:/var/jenkins_home jenkins/jenkins:2.457<br>docker ps | grep jenkins<br> 访问jenkins  <a href="http://192.168.163.155:8080">http://192.168.163.155:8080</a></p>
<p>关闭Jenkins容器，因为要修改配置</p>
<p>docker stop jenkins</p>
<p>6.4 配置jenkins环境<br>更换国内清华大学镜像,Jenkins下载插件特别慢，更换国内的清华源的镜像地址会快不少</p>
<p>cat /jenkins/hudson.model.UpdateCenter.xml</p>
<p>sed -i  ‘s#updates.jenkins.io/update-center.json#mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json#g ‘  /jenkins/hudson.model.UpdateCenter.xml<br>cat /jenkins/hudson.model.UpdateCenter.xml  </p>
<p> “<a href="https://www.google.com/”">https://www.google.com/”</a> 替换为 “<a href="https://www.baidu.com/”">https://www.baidu.com/”</a></p>
<p>yum install -y jq<br>cat /jenkins/updates/default.json | jq ‘.connectionCheckUrl’<br>cat /jenkins/updates/default.json | jq ‘keys’</p>
<p>替换</p>
<p>sed -i    s#<a href="https://www.google.com/#https://www.baidu.com/#g">https://www.google.com/#https://www.baidu.com/#g</a>  /jenkins/updates/default.json<br> 重启docker，获取登录密匙</p>
<p>docker start jenkins<br>cat /jenkins/secrets/initialAdminPassword</p>
<p> 需要修改jenkins绑定的docker的启动参数，ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H fd:// —containerd=/run/containerd/containerd.sock</p>
<p>vim /lib/systemd/system/docker.service</p>
<p>修改镜像库启动参数后需要重启docker</p>
<p>systemctl daemon-reload<br>systemctl restart docker<br>6.5 配置Jenkins 安装插件</p>
<p>安装和配置docker插件</p>
<p>依此点击Manage Jenkins-&gt;Manage Plugins-&gt;AVAILABLE-&gt;Search 搜索docker、docker-build-step</p>
<p>  需要修改harbor(192.168.163.156)的docker的启动参数，ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H fd:// —containerd=/run/containerd/containerd.sock</p>
<p>vim /lib/systemd/system/docker.service<br> 修改镜像库启动参数后需要重启docker</p>
<p>systemctl daemon-reload<br>systemctl restart docker</p>
<p>  以上docker配置是为了Build / Publish Docker Image时使用，定义了用那个服务器的docker执行docker命令</p>
<p>jenkins 安全设置</p>
<p>后面 gitlab 要和 jenkins 进行联动，所以必须要需要对 jenkins 的安全做一些设置，依次点击 系统管理-全局安全配置-授权策略，勾选”匿名用户具有可读权限”</p>
<p>七、Jenkins发布打包成Docker的spring boot项目到K8s集群<br>7.1 创建spring boot 项目</p>
<p>pom.xml</p>
<p>&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;</p>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.7.RELEASE</version>
    </parent>
    <groupId>com.example</groupId>
    <artifactId>demo</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>demo</name>
    <description>demo</description>
    <properties>
        <java.version>1.8</java.version>
        <java.version>1.8</java.version>
        <!--换成你的harbor仓库地址-->
        <docker.repostory>192.168.163.156</docker.repostory>
        <!--换成你的仓库项目名称-->
        <docker.registry.name>demo</docker.registry.name>
        <docker.image.tag>0.0.1</docker.image.tag>
        <docker.maven.plugin.version>1.4.10</docker.maven.plugin.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <finalName>demo</finalName>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>com.spotify</groupId>
                <artifactId>dockerfile-maven-plugin</artifactId>
                <version>${docker.maven.plugin.version}</version>
                <!--以下配置依赖docker环境 maven编译打包时会生成docker镜像 本地编译时先注释掉  上传git时在打开-->
                <executions>
                    <execution>
                        <id>default</id>
                        <goals>
                            <goal>build</goal>
                            <goal>push</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <contextDirectory>${project.basedir}</contextDirectory>
                    <useMavenSettingsForAuth>true</useMavenSettingsForAuth>
                    <repository>${docker.repostory}/${docker.registry.name}/${project.artifactId}</repository>
                    <!--换成你的harbor仓库账号密码-->
                    <username>admin</username>
                    <password>root123456</password>
                    <tag>${docker.image.tag}</tag>
                    <buildArgs>
                        <JAR_FILE>target/${project.build.finalName}.jar</JAR_FILE>
                    </buildArgs>
                </configuration>
            </plugin>
        </plugins>
        <resources>
            <!-- 指定 src/main/resources下所有文件及文件夹为资源文件 -->
            <resource>
                <directory>src/main/resources</directory>
                <targetPath>${project.build.directory}/classes</targetPath>
                <includes>
                    <include>**/*</include>
                </includes>
                <filtering>true</filtering>
            </resource>
        </resources>
    </build>
</project>

<p> 创建测试接口</p>
<p>package com.example.demo.api;</p>
<p>import lombok.AllArgsConstructor;<br>import org.springframework.web.bind.annotation.GetMapping;<br>import org.springframework.web.bind.annotation.RequestMapping;<br>import org.springframework.web.bind.annotation.RestController;</p>
<p>/**</p>
<ul>
<li>@author lgp</li>
<li>@description: 测试PI</li>
<li><p>@date 2023/9/6<br>*/<br> @RestController<br> @AllArgsConstructor<br> @RequestMapping(“/api”)<br> public class testApi {</p>
<p> @GetMapping(“/test”)<br> public String test() {</p>
<pre><code> return &quot;测试1112233552219122120911！！&quot;;
</code></pre><p> }</p>
</li>
</ul>
<p>}</p>
<p>启动项目</p>
<p>访问测试接口</p>
<p>添加Dockerfile文件</p>
<p>  该文件时docker创建容器的文件，名称不可改变</p>
<h1 id="添加依赖环境，前提是将Java8的Docker镜像从官方镜像仓库pull下来，然后上传到自己的Harbor私有仓库中"><a href="#添加依赖环境，前提是将Java8的Docker镜像从官方镜像仓库pull下来，然后上传到自己的Harbor私有仓库中" class="headerlink" title="添加依赖环境，前提是将Java8的Docker镜像从官方镜像仓库pull下来，然后上传到自己的Harbor私有仓库中"></a>添加依赖环境，前提是将Java8的Docker镜像从官方镜像仓库pull下来，然后上传到自己的Harbor私有仓库中</h1><p>FROM 192.168.163.156/library/java:8</p>
<h1 id="指定镜像制作作者，可自己随意设置"><a href="#指定镜像制作作者，可自己随意设置" class="headerlink" title="指定镜像制作作者，可自己随意设置"></a>指定镜像制作作者，可自己随意设置</h1><p>MAINTAINER admin</p>
<h1 id="运行目录"><a href="#运行目录" class="headerlink" title="运行目录"></a>运行目录</h1><p>VOLUME /tmp</p>
<h1 id="将本地的文件拷贝到容器，一般在项目的target目录下，要根据项目自己修改"><a href="#将本地的文件拷贝到容器，一般在项目的target目录下，要根据项目自己修改" class="headerlink" title="将本地的文件拷贝到容器，一般在项目的target目录下，要根据项目自己修改"></a>将本地的文件拷贝到容器，一般在项目的target目录下，要根据项目自己修改</h1><p>ADD target/*jar app.jar</p>
<h1 id="启动容器后自动执行的命令"><a href="#启动容器后自动执行的命令" class="headerlink" title="启动容器后自动执行的命令"></a>启动容器后自动执行的命令</h1><p>ENTRYPOINT [ “java”, “-Djava.security.egd=file:/dev/./urandom”, “-jar”, “/app.jar” ]<br>添加demo.yaml文件</p>
<p>该文件是k8s创建pod的配置文件</p>
<p>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: demo<br>  labels:<br>    app: demo<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: demo<br>  template:<br>    metadata:<br>      labels:<br>        app: demo<br>    spec:<br>      imagePullSecrets:                 #使用imagePullSecrets参数指定镜像拉取秘钥</p>
<pre><code>    - name: harbor-registry        #使用我们的secret，即harbor-registry
  containers:
  - name: demo
    image: 192.168.163.156/demo/demo:0.0.1
    ports:
    - containerPort: 8080   #修改成你项目的端口
    imagePullPolicy: Always #镜像拉取策略：每次都拉去最新的镜像
</code></pre><hr>
<p>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: demo<br>  labels:<br>    app: demo<br>spec:<br>  ports:</p>
<pre><code>- name: http
  port: 8080            #修改成你项目的端口
  nodePort: 30001      ##容器暴露的访问端口，要确定无冲突，否则需修改
</code></pre><p>  type: NodePort<br>  selector:<br>    app: demo</p>
<p>项目上传到gitlab </p>
<p>7.2 拉取java8镜像<br> 在jenkins服务器(192.168.163.155)上拉取java8镜像，然后推送至harbor仓库，一会打包构建docker镜像的时候会用到。</p>
<p>docker pull java:8<br>docker tag java:8 192.168.163.156/library/java:8<br>docker login 192.168.163.156<br>docker push 192.168.163.156/library/java:8</p>
<p>7.3 配置 jenkins容器到其他服务的ssh免密登录<br>jenkins执行构建命令时，需要ssh访问jenkins容器所在服务器（192.168.163.155）和k8s主节点服务器（192.168.163.151），所以需要配置ssh免密登录</p>
<p>在jenkins容器所在服务器（192.168.163.155）上进入jenkins容器</p>
<p>docker exec -it jenkins bash</p>
<p>生产密钥</p>
<p>ssh-keygen -t rsa<br>将公钥复制到jenkins容器所在服务器（192.168.163.155）</p>
<p>ssh-copy-id root@192.168.163.155</p>
<p> 将公钥复制到k8s主节点服务器（192.168.163.151)</p>
<p>7.4 k8s 创建私有镜像仓库Secret（k8s主节点服务器192.168.163.151）<br>k8s需要从harbor私有进行仓库拉取镜像时，需要创建Secret，配置harbor私有镜像仓库地址、账号密码</p>
<h1 id="docker-registry是关键字-harbor-registry是自定义的名称与demo-yaml中的imagePullSecrets-name值一致"><a href="#docker-registry是关键字-harbor-registry是自定义的名称与demo-yaml中的imagePullSecrets-name值一致" class="headerlink" title="docker-registry是关键字 harbor-registry是自定义的名称与demo.yaml中的imagePullSecrets.name值一致"></a>docker-registry是关键字 harbor-registry是自定义的名称与demo.yaml中的imagePullSecrets.name值一致</h1><p>kubectl -n default create secret docker-registry harbor-registry —docker-email=baidu.com@example —docker-username=root —docker-password=root123456 —docker-server=192.168.163.156    </p>
<p>kubectl get secret harbor-registry #查看secret</p>
<p>7.5 安装jdk和maven(jenkins:192.168.163.155)<br> 安装mvn</p>
<p>cd /usr/local/<br>wget <a href="https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz">https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</a><br>tar -zxvf apache-maven-3.6.3-bin.tar.gz<br>安装jdk</p>
<p>yum install -y java-1.8.0-openjdk-devel<br>配置环境变量</p>
<p>vim /etc/profile</p>
<p>MAVEN_HOME=/usr/local/apache-maven-3.6.3<br>JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.412.b08-1.el7_9.x86_64  ##这里的路径注意使用你安装的jdk的版本号<br>CLASS_PATH=.:$JAVA_HOME/lib<br>PATH=$MAVEN_HOME/bin:$JAVA_HOME/bin:$PATH<br> 刷新环境变量</p>
<p>source /etc/profile<br>检查是否安装成功</p>
<p>mvn -v<br>java -version</p>
<p>7.6 使用jenkins构建发布项目</p>
<h1 id="使用jenkins宿主机的maven打包-jenkins-workspace是jenkins-拉取git项目的目录-创建jenkins容器时已经做好了映射"><a href="#使用jenkins宿主机的maven打包-jenkins-workspace是jenkins-拉取git项目的目录-创建jenkins容器时已经做好了映射" class="headerlink" title="使用jenkins宿主机的maven打包 /jenkins/workspace是jenkins 拉取git项目的目录 创建jenkins容器时已经做好了映射"></a>使用jenkins宿主机的maven打包 /jenkins/workspace是jenkins 拉取git项目的目录 创建jenkins容器时已经做好了映射</h1><p>ssh -tt root@192.168.163.155 ‘docker rmi 192.168.163.156/demo/demo:0.0.1<br>    /usr/local/apache-maven-3.6.3/bin/mvn -f /jenkins/workspace/demo/pom.xml clean install -Dmaven.test.skip=true’<br>ssh -tt root@192.168.163.155 ‘docker login 192.168.163.156<br>    docker push  192.168.163.156/demo/demo:0.0.1’<br>scp /var/jenkins_home/workspace/demo/demo.yaml root@192.168.163.151:/<br>ssh -tt root@192.168.163.151 ‘/usr/bin/kubectl delete -f /demo.yaml’ #第一次执行时 由于没有该pod 会报错 所以第一次先注释掉<br>ssh -tt root@192.168.163.151 ‘/usr/bin/kubectl apply -f /demo.yaml’</p>
<p>镜像仓库</p>
<p>查看k8s pod</p>
<p>kubectl get pod —all-namespaces</p>
<p>访问应用：192.168.163.151:30001/api/test</p>
<p>方式二 构建 （比较麻烦 依赖于 6.5中的安装和配置docker插件）</p>
<p>  分为三步：</p>
<pre><code>  1.执行 shell maven编译生成jar包



    2.Build / Publish Docker Image 生成镜像并上传至镜像仓库
</code></pre><p>   3.执行 shell 远程k8s更新pod</p>
<p>以上项目部署CI/CD 还需要手动在jenkins中构建项目，下面整合Jenkins和gitlab，使用gitlab的webhook功能，实现代码提交到gitlab后 自动构建部署项目</p>
<p>1、master节点<br>1.1、在master节点执行下面reset命令：<br>kubeadm reset</p>
<p>//过程会询问是否重置，输入y然后回车</p>
<p>1.2、手动清除配置信息，这一步很关键：<br>cd ~ 进入根目录</p>
<p>ll -a 查看是否存在.kube文件<br>rm -rf /root/.kube</p>
<p>systemctl restart docker ## 重启docker<br>systemctl restart kubelet ## 重启kubelet</p>
<p>rm -rf /etc/cni/net.d<br>————————————————</p>
<pre><code>                        版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。
</code></pre><p>原文链接：<a href="https://blog.csdn.net/weixin_43025151/article/details/135536233">https://blog.csdn.net/weixin_43025151/article/details/135536233</a></p>
<h3 id="2、work节点"><a href="#2、work节点" class="headerlink" title="2、work节点"></a>2、work节点</h3><h4 id="2-1、重置工作节点"><a href="#2-1、重置工作节点" class="headerlink" title="2.1、重置工作节点"></a>2.1、重置工作节点</h4><p><code>kubeadm reset</code><br>//过程会询问是否重置，输入y然后回车</p>
<h4 id="2-2、手动删除目录"><a href="#2-2、手动删除目录" class="headerlink" title="2.2、手动删除目录"></a>2.2、手动删除目录</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rm -rf /root/.kube</span><br><span class="line">rm -rf /etc/cni/net.d</span><br><span class="line">rm -rf /etc/kubernetes/*</span><br></pre></td></tr></table></figure>
<h3 id="kubectl命令报错-“The-connection-to-the-server-localhost-8080-was-refused-did-you-specify-the-right-host-or-port-”"><a href="#kubectl命令报错-“The-connection-to-the-server-localhost-8080-was-refused-did-you-specify-the-right-host-or-port-”" class="headerlink" title="kubectl命令报错 “The connection to the server localhost:8080 was refused - did you specify the right host or port?”"></a>kubectl命令报错 “The connection to the server localhost:8080 was refused - did you specify the right host or port?”</h3><p>解决方法：<br>1.将主节点（master）中的“/etc/<a href="https://so.csdn.net/so/search?q=kubernetes&amp;spm=1001.2101.3001.7020">kubernetes</a>/admin.conf”文件拷贝到从节点相同目录下<br>2.配置环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>3.立即生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>
<p>常用命令</p>
<p>查看pod</p>
<p>kubectl get pods -A   /  kubectl get pods -All-namespaces #查看所有命令空间pod</p>
<p>kubectl get nodes #查看所有节点信息</p>
<p>kubectl logs  <yourpodname> -n <yournamespace>  #查看pod日志</p>
<p>kubectl logs <pod-name> -c <container-name> #查看pod中指定容器</p>
<p>kubectl logs <pod-name> —tail=20  #查看最后20行<br>kubectl logs <pod-name> —since=1h #查看最近一小时内的日志</p>
<p>kubectl describe pod <pod_name>  #描述pod</p>
<p>kubectl describe node <node_name>  #描述node</p>
<p>kubectl describe service <service_name> #描述service</p>
<p>kubectl cluster-info #查看集群信息</p>
<p>kubectl get <resource_type> #获取资源清单（pods、services、deployment)</p>
<p>kubectl create -f <filename> #创建资源</p>
<p>kubectl apply -f <filename> #更新资源</p>
<p>kubectl delete <resource_type> <resource_name> #删除资源</p>
<p>kubectl exec -it <pod_name> <em>— /bin/bash</em> #进入pod交互式终端</p>
<p>kubectl scale —replicas=<num> deployment/<deployment_name>  #<strong>扩展/缩放 Deployment</strong></p>
<p><strong>查看 ConfigMap 和 Secret：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Copy Codekubectl get configmaps</span><br><span class="line">kubectl get secrets</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>查看和修改节点标签：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Copy Codekubectl get nodes --show-labels</span><br><span class="line">kubectl label node &lt;node_name&gt; &lt;label_key&gt;=&lt;label_value&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>查看 API 资源：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Copy Codekubectl api-resources</span><br></pre></td></tr></table></figure>
<p><strong>查看 API 版本：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Copy Codekubectl api-versions</span><br></pre></td></tr></table></figure>
<p>yaml解释</p>
<p>apiVersion: v1 # 资源版本<br>kind: Service # 资源类型<br>metadata: # 元数据<br>  name: gateway # 资源名称<br>  namespace: peric718 # 命名空间<br>spec: # 详细配置<br>  ports: # 端口配置</p>
<ul>
<li>port: 10000 # 内部访问端口<br>name: gateway # 端口名称<br>nodePort: 30001 # 对外暴露端口<br>selector: # 选择器，用于指定当前资源作用于哪些pod<br>app: gateway<br>type: NodePort # 类型为NodePort</li>
</ul>
<hr>
<p>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: gateway<br>  namespace: peric718<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: gateway<br>  template: # pod副本创建模板。属性和Pod的属性一样<br>    metadata:<br>      labels: # 给要创建的pod打标签<br>        app: gateway<br>    spec:<br>      containers: # 使用的容器信息</p>
<pre><code>  - name: gateway
    image: 192.168.1.180:5000/aengus/gateway:v1.6
    # 拉取镜像策略：本地镜像不存在，从仓库取。有Always：中从仓库取。Never：总从本地取。
    imagePullPolicy: IfNotPresent 
    ports:
    - protocol: TCP
      containerPort: 10000 # 镜像映射出的端口
      env: # 镜像环境变量设置
      - name: NACOS_URL # nacos注册网址
        value: 192.168.1.181:8848
      - name: NACOS_DISCOVERY_NAMESPACE # nacos服务注册命名空间的环境变量
        value: 2a20a28f-6345-4ec7-ac28-ae525796736a
      - name: NACOS_CONFIG_NAMESPACE # nacos服务配置命名空间的环境变量
        value: 2a20a28f-6345-4ec7-ac28-ae525796736a
      - name: NACOS_DISCOVERRY_IP
        valueFrom:
          fieldRef:
             fieldPath: status.podIP
</code></pre>]]></content>
  </entry>
  <entry>
    <title>springcloud项目部署为https</title>
    <url>/2026/02/06/springcloud%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%BAhttps%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/</url>
    <content><![CDATA[<h1 id="springcloud项目部署为https"><a href="#springcloud项目部署为https" class="headerlink" title="springcloud项目部署为https"></a>springcloud项目部署为https</h1><h2 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h2><h3 id="1、安装jdk、openssl-并配置环境变量"><a href="#1、安装jdk、openssl-并配置环境变量" class="headerlink" title="1、安装jdk、openssl 并配置环境变量"></a>1、安装jdk、openssl 并配置环境变量</h3><h2 id="二、生成证书"><a href="#二、生成证书" class="headerlink" title="二、生成证书"></a>二、生成证书</h2><h3 id="1、注意事项"><a href="#1、注意事项" class="headerlink" title="1、注意事项"></a>1、注意事项</h3><p>1.1、 本次部署文档  采用  自签根证书、根证书签发服务证书、配置信任库的模式</p>
<p>1.2、下述证书名 密码 域名 IP地址均可替</p>
<p>1.3、网关使用gateway时，若gateway配置https，下游服务为http，使用lb:服务名形式设置uri 可能会导致 调用下游服务时请求会沿用https，请求失败。可用uri：主机名：端口的形式配置</p>
<p>1.4、除网关外的所有下游服务需要保持协议一致，若跨协议，feign调用会失败</p>
<p>1.5、证书文件类型可采用PKCS12等，JKS类型springboot可能会读取失败(仅限于本次测试结果)</p>
<h3 id="2、证书生成"><a href="#2、证书生成" class="headerlink" title="2、证书生成"></a>2、证书生成</h3><p>2.1.1、 生成根证书</p>
<p>keytool -genkeypair -alias rootca -keyalg RSA -keysize 2048 -validity 3650 -keystore rootca.jks<br>-dname “CN=Root CA, OU=OrgUnit, O=Org, L=City, ST=State, C=Country” -ext bc:c</p>
<p>参数说明：</p>
<p>alias: 证书别名</p>
<p>keystore: 证书文件名</p>
<p>dname: 描述信息</p>
<p>storepass：证书密钥</p>
<p>2.1.2 、导出根 CA 证书（如果还没有）<br>如果你已经有 rootca.cer，可以跳过这一步。否则，使用以下命令导出根 CA 证书：<br>keytool -exportcert -alias rootca -file rootca.crt -keystore rootca.jks -storepass 123456 -rfc</p>
<p>2.1.3、 提取根 CA 的私钥<br>由于 keytool 不直接支持从 JKS 提取私钥，我们可以先将 JKS 转换为 PKCS#12 格式，然后再使用 OpenSSL 提取私钥。<br>2.1.4、 将 JKS 转换为 PKCS#12 格式<br>keytool -importkeystore -srckeystore rootca.jks -destkeystore rootca.p12 -srcstoretype JKS -deststoretype PKCS12 -srcstorepass 123456 -deststorepass 123456 -alias rootca</p>
<p>2.1.5、 使用 OpenSSL 提取私钥<br>openssl pkcs12 -in rootca.p12 -nocerts -out rootca.key -nodes -passin pass:123456</p>
<p>2.2、生成服务证书</p>
<p>2.2.1、创建网关服务的密钥库并生成密钥对<br>使用 keytool 创建网关服务的密钥库并生成密钥对：<br>keytool -genkeypair -alias dist -keyalg RSA -keysize 2048 -keystore dist.jks -storepass 123456 -keypass 123456 -dname “CN=gateway.example.com, OU=OrgUnit, O=Organization, L=City, ST=State, C=CN”</p>
<p>2.2.2、从密钥库中导出证书签名请求 (CSR)<br>从网关密钥库中导出 CSR：<br>keytool -certreq -alias dist -file dist.csr -keystore dist.jks -storepass 123456</p>
<p>2.2.3、创建 OpenSSL 配置文件<br>创建一个名为 openssl.cnf 的配置文件，用于指定证书的详细信息和扩展字段：</p>
<h1 id="openssl-cnf"><a href="#openssl-cnf" class="headerlink" title="openssl.cnf"></a>openssl.cnf</h1><p>[ req ]<br>default_bits       = 2048<br>distinguished_name = req_distinguished_name<br>req_extensions     = req_ext<br>prompt             = no</p>
<p>[ req_distinguished_name ]<br>C  = CN<br>ST = State<br>L  = City<br>O  = Organization<br>OU = OrgUnit<br>CN = gateway.example.com</p>
<p>[ req_ext ]<br>subjectAltName = @alt_names</p>
<p>[ alt_names ]<br>IP.1 = 192.168.3.166<br>DNS.1 = gateway.example.com</p>
<p>2.2.4、 使用 OpenSSL 签发证书<br>使用 OpenSSL 签发证书并将 SAN 扩展添加到证书中：<br>openssl x509 -req -in dist.csr -CA rootca.crt -CAkey rootca.key -CAcreateserial -out dist.crt -days 365 -extfile openssl.cnf -extensions req_ext</p>
<p>2.2.5、导入根 CA 证书到网关密钥库<br>将根 CA 证书导入到网关密钥库中：<br>keytool -importcert -alias rootca -file rootca.crt -keystore dist.jks -storepass 123456 -noprompt</p>
<p>2.2.6、导入网关的签发证书到网关密钥库<br>将网关的签发证书导入到网关密钥库中：<br>keytool -importcert -alias dist -file dist.crt -keystore dist.jks -storepass 123456</p>
<p>2.2.7、将 JKS 转换为 PKCS#12 格式（可选）<br>keytool -importkeystore -srckeystore dist.jks -destkeystore dist.p12 -srcstoretype JKS -deststoretype PKCS12 -srcstorepass 123456 -deststorepass 123456  -alias dist</p>
<p>2.3、配置信任库</p>
<p>2.3.1、创建信任库</p>
<p>keytool -storetype JKS -keystore truststore.jks -storepass 123456 -deststoretype PKCS12</p>
<p>2.3.2  导入根 CA 证书到 truststore.p12<br>keytool -importcert -v -alias dist -file dist.cer -keystore truststore.p12 -storetype PKCS12 -storepass 123456 -noprompt</p>
<p>根证书 以及每个服务的证书都需要导入到信任库</p>
<h2 id="三、配置服务"><a href="#三、配置服务" class="headerlink" title="三、配置服务"></a>三、配置服务</h2><h2 id="1、springcloud-项目配置"><a href="#1、springcloud-项目配置" class="headerlink" title="1、springcloud 项目配置"></a>1、springcloud 项目配置</h2><p>1.1、将项目证书和信任库放到指定位置，（一般是项目resources下)</p>
<p>配置文件示例：</p>
<p>server:</p>
<p>  port: 10084</p>
<p>  servlet:</p>
<p>​    context-path:</p>
<p>  ssl:</p>
<p>​    enabled: false</p>
<p>​    key-store: classpath:bizz.p12  # 新服务的 keystore 文件路径</p>
<p>​    #key-store: file:/bizz.p12   # 绝对路径写法</p>
<p>​    key-store-password: 123456         # keystore 密码</p>
<p>​    key-alias: bizz   # 服务证书别名</p>
<p>​    key-store-type: PKCS12                # 证书文件类型</p>
<p>​    trust-store: classpath:truststore.p12  # 共享的信任库文件路径</p>
<p>​    trust-store-password: 123456        # 信任库密码</p>
<p>​    trust-store-type: PKCS12</p>
<h2 id="2、前端配置-项目中采用ngxin部署"><a href="#2、前端配置-项目中采用ngxin部署" class="headerlink" title="2、前端配置(项目中采用ngxin部署)"></a>2、前端配置(项目中采用ngxin部署)</h2><p>2.1、证书生成</p>
<p>按照上述方法生成前端证书，详见第二点</p>
<p>2.2、配置示例</p>
<h1 id="监听-HTTP-请求并重定向到-HTTPS"><a href="#监听-HTTP-请求并重定向到-HTTPS" class="headerlink" title="监听 HTTP 请求并重定向到 HTTPS"></a>监听 HTTP 请求并重定向到 HTTPS</h1><p>server {<br>    listen 80;<br>    server_name 192.168.3.166;  # 替换为 IP 地址</p>
<pre><code># 将 HTTP 请求重定向到 HTTPS
return 301 https://$host:5173$request_uri;
</code></pre><p>}</p>
<h1 id="监听-HTTPS-请求"><a href="#监听-HTTPS-请求" class="headerlink" title="监听 HTTPS 请求"></a>监听 HTTPS 请求</h1><p>server {<br>    listen 5173 ssl;<br>    server_name 192.168.3.166;  # 替换为 IP 地址</p>
<pre><code>ssl_certificate E:/nginx-1.18.0/conf/ssl/dist.crt;
ssl_certificate_key E:/nginx-1.18.0/conf/ssl/dist.key;


ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_ciphers HIGH:!aNULL:!MD5;

# 静态文件服务配置
location / &#123;
    root E:/kunteng/qianduan/OA/dist;  # 确保路径正确
    index index.html;
&#125;

# 反向代理到你的 Spring Cloud Gateway
location /api/ &#123;
    proxy_pass https://192.168.3.166:38760;  # 替换为实际的网关地址和端口
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
&#125;
</code></pre><p>}</p>
]]></content>
  </entry>
  <entry>
    <title>Docker企业级部署Elasticsearch与Kibana实践</title>
    <url>/2026/02/06/%E4%BC%81%E4%B8%9A%E7%BA%A7_Docker_ES_Kibana_%E9%83%A8%E7%BD%B2%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h1 id="Docker-企业级部署-Elasticsearch-Kibana-IK-分词器"><a href="#Docker-企业级部署-Elasticsearch-Kibana-IK-分词器" class="headerlink" title="Docker 企业级部署 Elasticsearch + Kibana + IK 分词器"></a>Docker 企业级部署 Elasticsearch + Kibana + IK 分词器</h1><blockquote>
<p>适用于：生产环境 / SpringCloud 微服务 / 日志平台 / 搜索服务</p>
</blockquote>
<p>特点： - docker-compose 一键部署 - 启用安全认证 - 持久化数据 -<br>插件标准化安装 - 容器网络隔离 - 可直接扩展为集群</p>
<hr>
<h1 id="一、目录规划（生产推荐）"><a href="#一、目录规划（生产推荐）" class="headerlink" title="一、目录规划（生产推荐）"></a>一、目录规划（生产推荐）</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/es/&#123;data,plugins,config,certs&#125;</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/kibana/&#123;config,data&#125;</span><br></pre></td></tr></table></figure>
<p>权限：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 /data/es</span><br><span class="line"><span class="built_in">chmod</span> -R 777 /data/kibana</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="二、docker-compose-企业级部署"><a href="#二、docker-compose-企业级部署" class="headerlink" title="二、docker-compose 企业级部署"></a>二、docker-compose 企业级部署</h1><p>创建：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/es-stack</span><br><span class="line"><span class="built_in">cd</span> /opt/es-stack</span><br><span class="line">vim docker-compose.yml</span><br></pre></td></tr></table></figure>
<h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch:8.6.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.type=single-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ES_JAVA_OPTS=-Xms1g</span> <span class="string">-Xmx1g</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ELASTIC_PASSWORD=Elastic@123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/es/data:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/es/plugins:/usr/share/elasticsearch/plugins</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9300:9300&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">es-net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kibana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kibana:8.6.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ELASTICSEARCH_HOSTS=http://es:9200</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ELASTICSEARCH_USERNAME=elastic</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ELASTICSEARCH_PASSWORD=Elastic@123</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5601:5601&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">es-net</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">es-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="三、启动服务"><a href="#三、启动服务" class="headerlink" title="三、启动服务"></a>三、启动服务</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>查看状态：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="四、访问测试"><a href="#四、访问测试" class="headerlink" title="四、访问测试"></a>四、访问测试</h1><p>Elasticsearch：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">http://服务器IP:9200</span><br></pre></td></tr></table></figure>
<p>账号：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">elastic</span><br><span class="line">Elastic@123</span><br></pre></td></tr></table></figure>
<p>Kibana：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">http://服务器IP:5601</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="五、企业级-IK-分词器安装"><a href="#五、企业级-IK-分词器安装" class="headerlink" title="五、企业级 IK 分词器安装"></a>五、企业级 IK 分词器安装</h1><p>进入容器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it es bash</span><br></pre></td></tr></table></figure>
<p>安装插件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./bin/elasticsearch-plugin install https://get.infini.cloud/elasticsearch/analysis-ik/8.6.0</span><br></pre></td></tr></table></figure>
<p>退出并重启：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker restart es</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="六、SpringBoot-企业连接配置"><a href="#六、SpringBoot-企业连接配置" class="headerlink" title="六、SpringBoot 企业连接配置"></a>六、SpringBoot 企业连接配置</h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">uris:</span> <span class="string">http://服务器IP:9200</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">elastic</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">Elastic@123</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="七、生产环境优化建议"><a href="#七、生产环境优化建议" class="headerlink" title="七、生产环境优化建议"></a>七、生产环境优化建议</h1><h2 id="JVM优化"><a href="#JVM优化" class="headerlink" title="JVM优化"></a>JVM优化</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">ES_JAVA_OPTS=-Xms2g</span> <span class="string">-Xmx2g</span></span><br></pre></td></tr></table></figure>
<p>原则： - 不超过物理内存 50% - Xms = Xmx</p>
<h2 id="内核参数（必须）"><a href="#内核参数（必须）" class="headerlink" title="内核参数（必须）"></a>内核参数（必须）</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
<p>生效：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="八、日志查看"><a href="#八、日志查看" class="headerlink" title="八、日志查看"></a>八、日志查看</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker logs -f es</span><br><span class="line">docker logs -f kibana</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="九、集群扩展（企业进阶）"><a href="#九、集群扩展（企业进阶）" class="headerlink" title="九、集群扩展（企业进阶）"></a>九、集群扩展（企业进阶）</h1><p>后续可扩展：</p>
<ul>
<li>ES 三节点集群</li>
<li>专用 master 节点</li>
<li>专用 data 节点</li>
<li>接入 Filebeat / Logstash</li>
<li>对接 SpringCloud 微服务日志中心</li>
<li>对接 MQTT / IoT 数据检索</li>
</ul>
<hr>
<h1 id="十、企业部署最佳实践总结"><a href="#十、企业部署最佳实践总结" class="headerlink" title="十、企业部署最佳实践总结"></a>十、企业部署最佳实践总结</h1><ul>
<li>使用 docker-compose 管理服务</li>
<li>必须开启安全认证</li>
<li>数据必须挂载宿主机</li>
<li>禁止 root 运行容器</li>
<li>JVM 内存按机器资源合理配置</li>
<li>插件版本必须与 ES 一致</li>
<li>生产环境建议至少三节点</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Docker企业级实战部署 Oracle11g</title>
    <url>/2026/02/06/%E4%BC%81%E4%B8%9A%E7%BA%A7_Docker_Oracle11g_%E5%AE%9E%E6%88%98%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="Docker-企业级实战部署-Oracle11g（11-2-0-3）"><a href="#Docker-企业级实战部署-Oracle11g（11-2-0-3）" class="headerlink" title="Docker 企业级实战部署 Oracle11g（11.2.0.3）"></a>Docker 企业级实战部署 Oracle11g（11.2.0.3）</h1><p>适用场景：</p>
<ul>
<li>本地开发环境</li>
<li>微服务数据库测试</li>
<li>Oracle 老系统迁移</li>
<li>内网测试数据库</li>
</ul>
<p>特点：</p>
<ul>
<li>一键部署</li>
<li>持久化建议</li>
<li>企业实战流程</li>
<li>启动监听与数据库</li>
<li>常见问题解决</li>
</ul>
<hr>
<h1 id="一、环境要求（生产建议）"><a href="#一、环境要求（生产建议）" class="headerlink" title="一、环境要求（生产建议）"></a>一、环境要求（生产建议）</h1><p>  项目     建议配置</p>
<hr>
<p>  CPU      ≥2核<br>  内存     ≥4G<br>  磁盘     ≥20G<br>  Docker   ≥20.x</p>
<p>检查 Docker：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker -v</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="二、拉取-Oracle11g-镜像"><a href="#二、拉取-Oracle11g-镜像" class="headerlink" title="二、拉取 Oracle11g 镜像"></a>二、拉取 Oracle11g 镜像</h1><h2 id="方式1：DockerHub（慢）"><a href="#方式1：DockerHub（慢）" class="headerlink" title="方式1：DockerHub（慢）"></a>方式1：DockerHub（慢）</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull lhrbest/oracle_11g_ee_lhr_11.2.0.3:1.0</span><br></pre></td></tr></table></figure>
<h2 id="方式2：阿里云镜像（推荐）"><a href="#方式2：阿里云镜像（推荐）" class="headerlink" title="方式2：阿里云镜像（推荐）"></a>方式2：阿里云镜像（推荐）</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/lhrbest/oracle_11g_ee_lhr_11.2.0.3:1.0</span><br></pre></td></tr></table></figure>
<p>重新打tag：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/lhrbest/oracle_11g_ee_lhr_11.2.0.3:1.0 lhrbest/oracle_11g_ee_lhr_11.2.0.3:1.0</span><br></pre></td></tr></table></figure>
<p>查看镜像：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker images | grep oracle</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="三、创建-Oracle-容器（实战标准）"><a href="#三、创建-Oracle-容器（实战标准）" class="headerlink" title="三、创建 Oracle 容器（实战标准）"></a>三、创建 Oracle 容器（实战标准）</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -itd --name oracle11g -h oracle11g --privileged=<span class="literal">true</span> -p 1521:1521 -p 1158:1158 -p 222:22 lhrbest/oracle_11g_ee_lhr_11.2.0.3:1.0 init</span><br></pre></td></tr></table></figure>
<p>端口说明：</p>
<p>  端口   作用</p>
<hr>
<p>  1521   数据库端口<br>  1158   EM管理<br>  222    SSH</p>
<hr>
<h1 id="四、启动数据库（核心步骤）"><a href="#四、启动数据库（核心步骤）" class="headerlink" title="四、启动数据库（核心步骤）"></a>四、启动数据库（核心步骤）</h1><p>进入容器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it oracle11g bash</span><br></pre></td></tr></table></figure>
<p>切换用户：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - oracle</span><br></pre></td></tr></table></figure>
<p>启动监听：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lsnrctl start</span><br></pre></td></tr></table></figure>
<p>进入数据库：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlplus / as sysdba</span><br></pre></td></tr></table></figure>
<p>启动实例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">startup;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="五、连接数据库"><a href="#五、连接数据库" class="headerlink" title="五、连接数据库"></a>五、连接数据库</h1><p>连接信息：</p>
<p>  项目   内容</p>
<hr>
<p>  IP     服务器IP<br>  端口   1521<br>  SID    LHR11G<br>  用户   system/sys</p>
<p>连接示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlplus system/oracle@服务器IP:1521/LHR11G</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="六、企业级持久化（强烈建议）"><a href="#六、企业级持久化（强烈建议）" class="headerlink" title="六、企业级持久化（强烈建议）"></a>六、企业级持久化（强烈建议）</h1><p>创建目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/oracle11g</span><br><span class="line"><span class="built_in">chmod</span> -R 777 /data/oracle11g</span><br></pre></td></tr></table></figure>
<p>推荐运行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -itd --name oracle11g --privileged=<span class="literal">true</span> -p 1521:1521 -v /data/oracle11g:/u01 lhrbest/oracle_11g_ee_lhr_11.2.0.3:1.0 init</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="七、SpringBoot连接配置"><a href="#七、SpringBoot连接配置" class="headerlink" title="七、SpringBoot连接配置"></a>七、SpringBoot连接配置</h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">oracle.jdbc.OracleDriver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:oracle:thin:@服务器IP:1521:LHR11G</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">system</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">oracle</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="八、常用管理命令"><a href="#八、常用管理命令" class="headerlink" title="八、常用管理命令"></a>八、常用管理命令</h1><p>查看监听：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lsnrctl status</span><br></pre></td></tr></table></figure>
<p>查看实例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> status <span class="keyword">from</span> v$instance;</span><br></pre></td></tr></table></figure>
<p>查看用户：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> username <span class="keyword">from</span> dba_users;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="九、日志查看"><a href="#九、日志查看" class="headerlink" title="九、日志查看"></a>九、日志查看</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker logs -f oracle11g</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="十、常见问题（实战踩坑）"><a href="#十、常见问题（实战踩坑）" class="headerlink" title="十、常见问题（实战踩坑）"></a>十、常见问题（实战踩坑）</h1><h2 id="1-无法连接"><a href="#1-无法连接" class="headerlink" title="1. 无法连接"></a>1. 无法连接</h2><p>检查：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">netstat -ntlp | grep 1521</span><br></pre></td></tr></table></figure>
<h2 id="2-数据库未启动"><a href="#2-数据库未启动" class="headerlink" title="2. 数据库未启动"></a>2. 数据库未启动</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">startup;</span><br></pre></td></tr></table></figure>
<h2 id="3-内存不足"><a href="#3-内存不足" class="headerlink" title="3. 内存不足"></a>3. 内存不足</h2><p>修改 Docker 启动内存限制。</p>
<hr>
<h1 id="十一、企业最佳实践"><a href="#十一、企业最佳实践" class="headerlink" title="十一、企业最佳实践"></a>十一、企业最佳实践</h1><ul>
<li>不要用于生产正式业务</li>
<li>建议用于开发测试</li>
<li>建议使用 Oracle19c 替代</li>
<li>建议加数据卷持久化</li>
<li>定期备份 /u01 目录</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>自签证书手册</title>
    <url>/2026/02/06/%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6/</url>
    <content><![CDATA[<h1 id="🧾-自签-RootCA-签发带多个-IP-的服务证书-导入信任库-全流程笔记"><a href="#🧾-自签-RootCA-签发带多个-IP-的服务证书-导入信任库-全流程笔记" class="headerlink" title="🧾 自签 RootCA + 签发带多个 IP 的服务证书 + 导入信任库 全流程笔记"></a>🧾 自签 RootCA + 签发带多个 IP 的服务证书 + 导入信任库 全流程笔记</h1><h2 id="📁-目录结构建议"><a href="#📁-目录结构建议" class="headerlink" title="📁 目录结构建议"></a>📁 目录结构建议</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">certs/</span><br><span class="line">├── rootca/</span><br><span class="line">│   ├── rootca-key.pem</span><br><span class="line">│   ├── rootca-cert.pem</span><br><span class="line">│   └── rootca.p12</span><br><span class="line">├── gateway/</span><br><span class="line">│   ├── prodgateway-key.pem</span><br><span class="line">│   ├── prodgateway.csr</span><br><span class="line">│   ├── prodgateway-cert.pem</span><br><span class="line">│   └── prodgateway.p12</span><br><span class="line">└── openssl-san.cnf</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="1️⃣-创建-RootCA-根证书（如已存在可跳过）"><a href="#1️⃣-创建-RootCA-根证书（如已存在可跳过）" class="headerlink" title="1️⃣ 创建 RootCA 根证书（如已存在可跳过）"></a>1️⃣ 创建 RootCA 根证书（如已存在可跳过）</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成 RootCA 私钥</span></span><br><span class="line">openssl genrsa -out rootca-key.pem 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 RootCA 证书</span></span><br><span class="line">openssl req -x509 -new -nodes -key rootca-key.pem -sha256 -days 3650 -out rootca-cert.pem -subj <span class="string">&quot;/C=CN/ST=State/L=City/O=Organization/OU=OrgUnit/CN=rootca&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选：导出为 truststore.p12</span></span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out rootca.p12 -inkey rootca-key.pem -<span class="keyword">in</span> rootca-cert.pem -name rootca</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2️⃣-创建包含多个-IP-的-OpenSSL-配置文件"><a href="#2️⃣-创建包含多个-IP-的-OpenSSL-配置文件" class="headerlink" title="2️⃣ 创建包含多个 IP 的 OpenSSL 配置文件"></a>2️⃣ 创建包含多个 IP 的 OpenSSL 配置文件</h2><p>新建文件 <code>openssl-san.cnf</code>，内容如下：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[req]</span></span><br><span class="line"><span class="attr">distinguished_name</span> = req_distinguished_name</span><br><span class="line"><span class="attr">req_extensions</span> = v3_req</span><br><span class="line"><span class="attr">prompt</span> = <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="section">[req_distinguished_name]</span></span><br><span class="line"><span class="attr">C</span> = CN</span><br><span class="line"><span class="attr">ST</span> = State</span><br><span class="line"><span class="attr">L</span> = City</span><br><span class="line"><span class="attr">O</span> = Organization</span><br><span class="line"><span class="attr">OU</span> = OrgUnit</span><br><span class="line"><span class="attr">CN</span> = prodgateway.example.com</span><br><span class="line"></span><br><span class="line"><span class="section">[v3_req]</span></span><br><span class="line"><span class="attr">keyUsage</span> = keyEncipherment, dataEncipherment, digitalSignature</span><br><span class="line"><span class="attr">extendedKeyUsage</span> = serverAuth</span><br><span class="line"><span class="attr">subjectAltName</span> = @alt_names</span><br><span class="line"></span><br><span class="line"><span class="section">[alt_names]</span></span><br><span class="line"><span class="attr">IP.1</span> = <span class="number">192.168</span>.<span class="number">3.166</span></span><br><span class="line"><span class="attr">IP.2</span> = <span class="number">192.168</span>.<span class="number">3.197</span></span><br><span class="line"><span class="attr">IP.3</span> = <span class="number">192.168</span>.<span class="number">3.201</span></span><br><span class="line"><span class="attr">IP.4</span> = <span class="number">113.250</span>.<span class="number">177.98</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3️⃣-生成服务证书和私钥（prodgateway）"><a href="#3️⃣-生成服务证书和私钥（prodgateway）" class="headerlink" title="3️⃣ 生成服务证书和私钥（prodgateway）"></a>3️⃣ 生成服务证书和私钥（prodgateway）</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">openssl genrsa -out prodgateway-key.pem 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 CSR（证书签署请求）</span></span><br><span class="line">openssl req -new -key prodgateway-key.pem -out prodgateway.csr -config openssl-san.cnf</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="4️⃣-使用-rootca-签署-prodgateway-证书"><a href="#4️⃣-使用-rootca-签署-prodgateway-证书" class="headerlink" title="4️⃣ 使用 rootca 签署 prodgateway 证书"></a>4️⃣ 使用 rootca 签署 prodgateway 证书</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> prodgateway.csr -CA rootca-cert.pem -CAkey rootca-key.pem -CAcreateserial -out prodgateway-cert.pem -days 365 -sha256 -extensions v3_req -extfile openssl-san.cnf</span><br></pre></td></tr></table></figure>
<p>📌 <code>-CAcreateserial</code> 会自动生成 <code>rootca-cert.srl</code> 文件。</p>
<hr>
<h2 id="5️⃣-可选：打包为-p12-格式（供-Java-使用或导入-Truststore）"><a href="#5️⃣-可选：打包为-p12-格式（供-Java-使用或导入-Truststore）" class="headerlink" title="5️⃣ 可选：打包为 .p12 格式（供 Java 使用或导入 Truststore）"></a>5️⃣ 可选：打包为 <code>.p12</code> 格式（供 Java 使用或导入 Truststore）</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> prodgateway-cert.pem -inkey prodgateway-key.pem -out prodgateway.p12 -name prodgateway -CAfile rootca-cert.pem -caname rootca</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="6️⃣-导入-prodgateway-p12-到现有-Truststore"><a href="#6️⃣-导入-prodgateway-p12-到现有-Truststore" class="headerlink" title="6️⃣ 导入 prodgateway.p12 到现有 Truststore"></a>6️⃣ 导入 <code>prodgateway.p12</code> 到现有 Truststore</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">keytool -importkeystore -deststorepass 123456 -destkeystore truststore.p12 -srckeystore prodgateway.p12 -srcstoretype PKCS12 -srcstorepass 123456</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>truststore.p12</code> 是你已有的信任库  </li>
<li>可用以下命令查看条目：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">keytool -list -keystore truststore.p12 -storepass 123456</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<hr>
<h2 id="7️⃣-验证-SAN-是否包含-IP"><a href="#7️⃣-验证-SAN-是否包含-IP" class="headerlink" title="7️⃣ 验证 SAN 是否包含 IP"></a>7️⃣ 验证 SAN 是否包含 IP</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> prodgateway-cert.pem -noout -text | findstr /C:<span class="string">&quot;Subject Alternative Name&quot;</span></span><br></pre></td></tr></table></figure>
<p>应看到：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">X509v3 Subject Alternative Name:</span><br><span class="line">    IP Address:192.168.3.166, IP Address:192.168.3.197, ...</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="✅-最终用途"><a href="#✅-最终用途" class="headerlink" title="✅ 最终用途"></a>✅ 最终用途</h2><ul>
<li><strong>Nginx / 前端服务</strong> 可配置 <code>prodgateway-cert.pem + prodgateway-key.pem</code></li>
<li><strong>浏览器不会再报 ERR_CERT_AUTHORITY_INVALID</strong></li>
<li><strong>HTTPS API 请求能通过 Truststore 验证</strong></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>搭建maven私服手册</title>
    <url>/2026/02/06/%E6%90%AD%E5%BB%BAmaven%E7%A7%81%E6%9C%8D/</url>
    <content><![CDATA[<h1 id="搭建maven私服"><a href="#搭建maven私服" class="headerlink" title="搭建maven私服"></a>搭建maven私服</h1><h2 id="一、docker版本"><a href="#一、docker版本" class="headerlink" title="一、docker版本"></a>一、docker版本</h2><p>docker pull sonatype/nexus3</p>
<p>mkdir -p /home/nexus/data<br>chmod 777 -R /home/nexus/data</p>
<p>docker run -d —name nexus3 -p 8081:8081 —restart always -v /home/nexus/data:/nexus-data sonatype/nexus3</p>
<p>docker logs -f nexus3</p>
<p>访问地址：http:ip:8081</p>
<p>默认密码存放位置：</p>
<p>cat /home/nexus/data/admin.password</p>
<p>1、默认仓库说明：</p>
<p>maven-central：maven中央库，默认从<a href="https://repo1.maven.org/maven2/拉取jar">https://repo1.maven.org/maven2/拉取jar</a><br>maven-releases：私库发行版jar，初次安装请将Deployment policy设置为Allow redeploy<br>maven-snapshots：私库快照（调试版本）jar<br>maven-public：仓库分组，把上面三个仓库组合在一起对外提供服务，在本地maven基础配置settings.xml或项目pom.xml中使用</p>
<p>2、nexus仓库类型说明</p>
<p>hosted：本地仓库，通常我们会部署自己的构件到这一类型的仓库。比如公司的第二方库。<br>proxy：代理仓库，它们被用来代理远程的公共仓库，如maven中央仓库。<br>group：仓库组，用来合并多个hosted/proxy仓库，当你的项目希望在多个repository使用资源时就不需要多次引用了，只需要引用一个group即可。</p>
<p>3、创建Blob stores</p>
<p>在创建repository之前，还需要先指定文件存储目录，便于统一管理。就需要创建Blob Stores，不创建则使用的是default</p>
<p>4、</p>
<p>jboss的maven中央仓库地址：<a href="http://repository.jboss.com/maven2/">http://repository.jboss.com/maven2/</a><br>阿里云的maven中央仓库地址：<a href="http://maven.aliyun.com/nexus/content/groups/public/">http://maven.aliyun.com/nexus/content/groups/public/</a><br>apache的maven中央仓库地址：<a href="http://repo.maven.apache.org/maven2/">http://repo.maven.apache.org/maven2/</a></p>
<p>Hosted有三种方式：Releases、Snapshot、Mixed</p>
<p>Releases: 一般是已经发布的Jar包<br>Snapshot: 未发布的版本<br>Mixed：混合的</p>
<p>Allow redeploy：允许同一个版本号下重复提交代码, nexus以时间区分<br>Disable redeploy：不允许同一个版本号下重复提交代码<br>Read-Only：不允许提交任何版本<br>原生的maven-releases库是Disable redeploy设置， maven-snapshots是Allow redeploy。</p>
<p>5、settings.xml 配置</p>
<p>&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;</p>
<settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">

    <localRepository>D:\123</localRepository>

    <pluginGroups>
    </pluginGroups>


    <proxies>
    </proxies>

    <servers>

        <server>
            <id>maven-public</id>
            <username>admin</username>
            <password>123456</password>
        </server>

    </servers>


    <mirrors>

        <mirror>
            <id>maven-public</id>
            <mirrorOf>*</mirrorOf>
            <name>maven-public</name>
            <url>http://192.168.3.108:8081/repository/maven-public/</url>
        </mirror>

    </mirrors>

    <profiles>

        <!-- 配置私服 -->

        <profile>
            <id>maven-public</id>
            <repositories>
                <repository>
                    <id>maven-public</id>
                    <name>Repository for nexus</name>
                    <url>http://192.168.3.108:8081/repository/maven-public/</url>
                </repository>
            </repositories>
        </profile>


    </profiles>

    <!-- 配置私服 -->

    <activeProfiles>
        <activeProfile>maven-public</activeProfile>
    </activeProfiles>
</settings>



<h2 id="二、windows版"><a href="#二、windows版" class="headerlink" title="二、windows版"></a>二、windows版</h2><p>1、下载地址</p>
<p><a href="https://help.sonatype.com/en/download.html">Download</a></p>
<p>2、运行</p>
<p>D:\App\nexus-3.55.0-01-win64\nexus-3.55.0-01\bin&gt;nexus.exe /run</p>
<p>用户名：admin（默认）</p>
<p>密码：第一次启动时生成，(在/sonatype-work/nexus3/admin.password 文件中) </p>
]]></content>
  </entry>
  <entry>
    <title>canal手册</title>
    <url>/2026/02/06/%E6%8B%89%E5%8F%96%E7%89%88%E6%9C%AC%E4%B8%BAv1.1.5%E7%9A%84canal/</url>
    <content><![CDATA[<p>docker run —privileged=true \<br>—log-driver json-file \<br>—log-opt max-size=100m \<br>—log-opt max-file=2 \<br>—name kafka -p 9092:9092 \<br>-e KAFKA_BROKER_ID=0 \<br>-e KAFKA_ZOOKEEPER_CONNECT=192.168.71.134:2181/kafka \<br>-e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.71.134:9092 \<br>-e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \<br>-e ALLOW_PLAINTEXT_LISTENER=yes \<br>-e KAFKA_HEAP_OPTS=’-Xms512M -Xmx4G’ \<br>-v /home/kafka/:/opt/kafka/ \<br>-v /etc/localtime:/etc/localtime \<br>-d wurstmeister/kafka:2.12-2.3.1<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>命令    注释<br>–privileged=true    表示容器内的root拥有真正的root权限<br>–log-driver json-file    表示使用 JSON 文件作为日志驱动<br>–log-opt max-size=100m    表示设置日志的最大大小为100MB<br>–log-opt max-file=2    表示设置日志文件的最大数量<br>–name    表示容器命名<br>-p    表示端口映射<br>-e KAFKA_BROKER_ID=0    表示这个ID是集群的标识，不能重复<br>-e KAFKA_ZOOKEEPER_CONNECT=IP:2181/kafka    表示zookeeper的连接地址<br>-e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://IP:9092    表示kafka发布到zookeeper供客户端使用的服务地址<br>-e ALLOW_PLAINTEXT_LISTENER=yes    表示允许使用PLAINTEXT侦听器<br>-e KAFKA_HEAP_OPTS=’-Xms512M -Xmx4G    表示行内存参数<br>-v /home/kafka/data:/wurstmeister/kafka/data    表示挂载配置数据目录<br>-v /home/kafka/config:/wurstmeister/kafka/config    表示配置文件目录<br>-v /etc/localtime:/etc/localtime    表示将本地时间映射到容器中<br>-d    表示后台运行</p>
<p>./kafka-topics.sh —create —topic test-kafka —bootstrap-server localhost:9092<br>kafka-topics.sh —describe —topic test-kafka —bootstrap-server localhost:9092</p>
<p>3.拉取Cannal镜像</p>
<h2 id="拉取版本为v1-1-5的canal"><a href="#拉取版本为v1-1-5的canal" class="headerlink" title="拉取版本为v1.1.5的canal"></a>拉取版本为v1.1.5的canal</h2><p>docker pull canal/canal-server:v1.1.5<br>1<br>2<br>4.运行Canal<br>4.1、启动命令<br>docker run -p 11111:11111 —name canal \<br>-e canal.destinations=test \<br>-e canal.instance.master.address=mysql:3306  \<br>-e canal.instance.dbUsername=canal  \<br>-e canal.instance.dbPassword=canal  \<br>-e canal.instance.connectionCharset=UTF-8 \<br>-e canal.instance.tsdb.enable=true \<br>-e canal.instance.gtidon=false  \<br>-e canal.instance.filter.regex=test\..* \<br>—network mysql-test \<br>—restart=always \<br>-d canal/canal-server:v1.1.5<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>启动命令说明：</p>
<p>4.2、命令解读<br>① -p ：指定端口<br>② -e ：指定配置文件的配置信息。此处主要有两个配置文件在起作用，分别是 canal.properties 和 instance.properties 这两个配置文件，前缀是 canal. 的修改就是 canal.properties 这个配置文件的，前缀是 canal.instance 修改的就是 instance.properties 这个配置文件的<br>③ canal.destinations：指定了实例的名称，决定了instance实例的配置文件存放目录<br>④ canal.instance.master.address ：指定了mysql的地址，正常需要ip，此处由于会将mysql和canal放在一个网络中，所以可以直接使用mysql替代<br>⑤ canal.instance.filter.regex：此处指定只过滤test这个数据库的binlog数据<br>⑥ network mysql-test：指定网络是步骤1创建的网络<br>⑦ restart=always ：将canal设置为docker启动时自启，可要可不要<br>⑧ -d ：指定步骤2拉取的镜像名称以及版本</p>
<p>4.3、查看容器状态</p>
<h1 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h1><p>docker logs canal</p>
<h1 id="查看目前运行容器"><a href="#查看目前运行容器" class="headerlink" title="查看目前运行容器"></a>查看目前运行容器</h1><p>docker ps</p>
<h1 id="启动失败时查看容器状态"><a href="#启动失败时查看容器状态" class="headerlink" title="启动失败时查看容器状态"></a>启动失败时查看容器状态</h1><p>docker ps -a<br>1<br>2<br>3<br>4<br>5<br>6<br>4.4、相关配置调整（可做可不做）<br>①将canal配置文件进行拷贝</p>
<h1 id="canal-properties-amp-instance-properties"><a href="#canal-properties-amp-instance-properties" class="headerlink" title="canal.properties &amp; instance.properties"></a>canal.properties &amp; instance.properties</h1><h1 id="注意，instance-properties文件是在canal-destinations这个配置指定的目录作为前缀下面"><a href="#注意，instance-properties文件是在canal-destinations这个配置指定的目录作为前缀下面" class="headerlink" title="注意，instance.properties文件是在canal.destinations这个配置指定的目录作为前缀下面"></a>注意，instance.properties文件是在canal.destinations这个配置指定的目录作为前缀下面</h1><p>docker cp canal:/home/admin/canal-server/conf/canal.properties /mydata/canal/conf<br>docker cp canal:/home/admin/canal-server/conf/test/instance.properties /mydata/canal/conf</p>
<p>1<br>2<br>3<br>4<br>5<br>6<br>②根据个人需要修改配置之后，将原有的canal容器停止并删除，然后重新启动的时候使用-v进行文件绑定，进行文件绑定时务必确保文件是存在的。</p>
<h1 id="停止并删除容器"><a href="#停止并删除容器" class="headerlink" title="停止并删除容器"></a>停止并删除容器</h1><p>docker stop canal<br>docker rm canal</p>
<h1 id="重新运行并指定"><a href="#重新运行并指定" class="headerlink" title="重新运行并指定"></a>重新运行并指定</h1><p>docker run -p 11111:11111 —name canal \<br>-e canal.destinations=test \<br>-e canal.instance.master.address=mysql:3306  \<br>-e canal.instance.dbUsername=canal  \<br>-e canal.instance.dbPassword=canal  \<br>-e canal.instance.connectionCharset=UTF-8 \<br>-e canal.instance.tsdb.enable=true \<br>-e canal.instance.gtidon=false  \<br>-e canal.instance.filter.regex=test\..* \<br>-v /mydata/canal/conf/canal.properties:/home/admin/canal-server/conf/canal.properties \<br>-v /mydata/canal/conf/instance.properties:/home/admin/canal-server/conf/test/instance.properties \<br>—network mysql-test \<br>—restart=always \<br>-d canal/canal-server:v1.1.5</p>
<p>docker run -p 11111:11111 —name canal \<br>-v /mydata/canal/conf:/home/admin/canal-server/conf \<br>—restart=always \<br>-d canal/canal-server:v1.1.5</p>
<p>找到canal.deployer-1.1.4/conf目录下的canal.properties配置文件：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tcp, kafka, RocketMQ 这里选择kafka模式</span></span><br><span class="line"><span class="attr">canal.serverMode</span> = <span class="string">kafka</span></span><br><span class="line"><span class="comment"># 解析器的线程数，打开此配置，不打开则会出现阻塞或者不进行解析的情况</span></span><br><span class="line"><span class="attr">canal.instance.parser.parallelThreadSize</span> = <span class="string">16</span></span><br><span class="line"><span class="comment"># 配置MQ的服务地址，这里配置的是kafka对应的地址和端口</span></span><br><span class="line"><span class="attr">canal.mq.servers</span> = <span class="string">127.0.0.1:9092</span></span><br><span class="line"><span class="comment"># 配置instance，在conf目录下要有example同名的目录，可以配置多个</span></span><br><span class="line"><span class="attr">canal.destinations</span> = <span class="string">example</span></span><br></pre></td></tr></table></figure>
<p>然后配置instance，找到/conf/example/instance.properties配置文件：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## mysql serverId , v1.0.26+ will autoGen(自动生成，不需配置)</span></span><br><span class="line"><span class="comment"># canal.instance.mysql.slaveId=0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># position info</span></span><br><span class="line"><span class="attr">canal.instance.master.address</span>=<span class="string">127.0.0.1:3306</span></span><br><span class="line"><span class="comment"># 在Mysql执行 SHOW MASTER STATUS;查看当前数据库的binlog</span></span><br><span class="line"><span class="attr">canal.instance.master.journal.name</span>=<span class="string">mysql-bin.000006</span></span><br><span class="line"><span class="attr">canal.instance.master.position</span>=<span class="string">4596</span></span><br><span class="line"><span class="comment"># 账号密码</span></span><br><span class="line"><span class="attr">canal.instance.dbUsername</span>=<span class="string">canal</span></span><br><span class="line"><span class="attr">canal.instance.dbPassword</span>=<span class="string">Canal@****</span></span><br><span class="line"><span class="attr">canal.instance.connectionCharset</span> = <span class="string">UTF-8</span></span><br><span class="line"><span class="comment">#MQ队列名称</span></span><br><span class="line"><span class="attr">canal.mq.topic</span>=<span class="string">canaltopic</span></span><br><span class="line"><span class="comment">#单队列模式的分区下标</span></span><br><span class="line"><span class="attr">canal.mq.partition</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用命令登录：mysql -u root -p</span></span><br><span class="line"><span class="comment">-- 创建用户 用户名：canal 密码：Canal@123456</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;Canal@123456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 授权 *.*表示所有库</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">SELECT</span>, REPLICATION SLAVE, REPLICATION CLIENT <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;Canal@123456&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>下一步在MySQL配置文件my.cnf设置如下信息：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line">[<span class="string">mysqld</span>]</span><br><span class="line"><span class="comment"># 打开binlog</span></span><br><span class="line"><span class="string">log-bin=mysql-bin</span></span><br><span class="line"><span class="comment"># 选择ROW(行)模式</span></span><br><span class="line"><span class="string">binlog-format=ROW</span></span><br><span class="line"><span class="comment"># 配置MySQL replaction需要定义，不要和canal的slaveId重复</span></span><br><span class="line"><span class="string">server_id=1</span></span><br></pre></td></tr></table></figure>
<p>改了配置文件之后，重启MySQL，使用命令查看是否打开binlog模式：</p>
<p>show variables like ‘log_bin’;</p>
<p>查看binlog日志文件列表：</p>
<p>show binary logs;</p>
<p>查看当前正在写入的binlog文件：</p>
<p>show master status;</p>
<p>MySQL服务器这边就搞定了，很简单。</p>
]]></content>
  </entry>
  <entry>
    <title>证书更换手册</title>
    <url>/2026/02/06/%E8%AF%81%E4%B9%A6%E6%9B%B4%E6%8D%A2%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h2 id="一、-前置条件"><a href="#一、-前置条件" class="headerlink" title="一、 前置条件"></a>一、 前置条件</h2><p>1、需要安装openssl</p>
<h2 id="二、转换证书格式"><a href="#二、转换证书格式" class="headerlink" title="二、转换证书格式"></a>二、转换证书格式</h2><p>1、转换为PKCS12(推荐)</p>
<p>openssl pkcs12 -export -in <em>.scaxkc.com_bundle.crt -inkey </em>.scaxkc.com_RSA.key -out scaxkc-gateway.p12 -name scaxkc-gateway</p>
<p>执行上述命令后会提示输入密码、和确认密码</p>
<p>参数说明：</p>
<p>_.scaxkc.com_bundle.crt：证书文件</p>
<p>_.scaxkc.com_RSA.key：私钥文件</p>
<p>-name:指定证书别名（可自行定义，但尽量不重复）</p>
<p>2、springboot配置</p>
<p>1、将证书放置resources目录下</p>
<p>2、配置在服务配置文件ssl块下</p>
<p>示例：</p>
<p>ssl:</p>
<p>​    enable: true</p>
<p>​    key-store: classpath:scaxkc-gateway.p12 # 新服务的 keystore 文件路径</p>
<p>​    key-store-password: Kunteng@123         # keystore 密码</p>
<p>​    key-alias: scaxkc-gateway</p>
<p>​    key-store-type: PKCS12 </p>
]]></content>
  </entry>
  <entry>
    <title>数通笔记</title>
    <url>/2023/07/25/%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="华为DHCP服务器配置：display-ip-pool"><a href="#华为DHCP服务器配置：display-ip-pool" class="headerlink" title="华为DHCP服务器配置：display ip pool"></a>华为DHCP服务器配置：display ip pool</h1><p>方法一：基于接口地址池<br>　1.全局启用DHCP：dhcp  enable<br>　2.接口中选DHCP方法：int　接口号<br>　　 　　　　　　　　 dhcp 　select　 int<br>  3.定义DHCP选项（Option）：<br>   Option3：自动为接口IP，无须配置<br>   Option6：dhcp  server  dns-list  DNS服务器地址<br>  4.排除范围（可选）：dhcp  server  excl  起始地址　结束地址<br>  5.租期（可选）：dhcp  server  Lease  ? ? ?</p>
<p>方法二：基于全局地址池<br>1.全局启用DHCP：dhcp  enable<br> 2.创建地址池：ip  pool  池名<br> 3.定义DHCP选项（Option）<br>  方法1：用Option命令：option 选项号 ip 地址<br>  方法2：手工配置<br>  Option3（Router）：gateway-list 默认网关<br>　Option6（DNS Server）：dns-list DNS服务器地址<br>4.范围：network 　网络　mask　掩码<br>5.排除范围（可选）：excl 　起始地址　结束地址<br>6.接口中选DHCP方法：int　接口号<br>　　　　　　　　　　 dhcp 　select　 global</p>
<ol>
<li>.租期（可选）：dhcp  server  Lease  ? ? ?</li>
<li>dhcp server forbidden-ip 10.0.20.1 10.0.20.100 禁止将pc网关分配给用户</li>
</ol>
<p>DHCP Client：<br>Windows PC机：ipconfig、ipconfig /release、ipconfig /renew、ipconfig /all<br>华为Router以太网接口：ip  add  dhcp-a （dis ip int br、 dis ip rout 、 dis  dns  server）</p>
<h1 id="端口隔离"><a href="#端口隔离" class="headerlink" title="端口隔离"></a>端口隔离</h1><p>SWA<br>sys<br>port-isolate group 1<br>int g1/0/1<br> port-isolate enable group 1<br>int g1/0/2<br> port-isolate enable group 1<br>int g1/0/3<br> port-isolate enable group 1</p>
<p>dis port-isolate group 1</p>
<h1 id=""><a href="#" class="headerlink" title=" "></a> </h1><h1 id="链路类型"><a href="#链路类型" class="headerlink" title="链路类型"></a>链路类型</h1><p>接口模式</p>
<p>SW1<br>sys<br>sys SW1<br>vlan 2<br> port g1/0/1 access<br> port g1/0/2 access<br>vlan 10<br> port g1/0/3 access<br>dis vlan brief</p>
<p>trunk 模式</p>
<p>SW1<br>sys<br>vlan 2<br> port g1/0/2<br>vlan 10<br> port g1/0/3<br>int g1/0/1<br> port link-type trunk<br> port trunk permit vlan all<br>dis vlan brief<br>dis int g1/0/1</p>
<h1 id="stp-pvst"><a href="#stp-pvst" class="headerlink" title="stp pvst"></a>stp pvst</h1><p>SWA<br>sys<br>vlan 11 to 12<br>vlan 21 to 22<br>vlan 31 to 32<br>int g1/0/1<br> port link-type trunk<br> port trunk permit vlan all<br>int g1/0/2<br> port link-type trunk<br> port trunk permit vlan all<br>qu<br>stp mode pvst<br>stp vlan 11 21 31 root primary<br>stp vlan 12 22 32 root secondary</p>
<p>ip ttl-expires enable   开启设备的ICMP超时报文的发送功能<br>ip unreachables enable  开启设备的ICMP目的不可达报文的发送功能</p>
<p>华三  宣告默认路由</p>
<p>rip    default-route or</p>
<p>ospf     default-route-adv</p>
<h1 id="ACL过滤"><a href="#ACL过滤" class="headerlink" title="ACL过滤"></a>ACL过滤</h1><p>acl advanced 3000<br> rule 0 deny ip source 10.1.1.2 0 destination 10.2.2.2 0<br> rule 5 deny tcp source 10.1.1.3 0 destination 10.2.2.2 0 destination-port eq www<br> rule 10 deny tcp source 10.1.1.4 0 destination 10.2.2.2 0 destination-port eq ftp<br>int g0/0<br> packet-filter 3000 inbound</p>
<p>dis acl 3000<br>dis cu int g0/0<br>dis packet-filter statistics int g0/0 inbound </p>
<p>华为接口过滤</p>
<p>acl 3050<br> rule deny ip source 10.0.50.0 0.0.0.255 destin 10.0.0.0 0.255.255.255<br>int g0/0/4<br> traffic-filter inbound acl 3050</p>
<p>reset saved-configuration 华三清楚配置命令</p>
<p>ctrl+B或E</p>
<h1 id="IP-v6"><a href="#IP-v6" class="headerlink" title="IP v6"></a>IP v6</h1><p>sysn RTD<br>int g0/2<br> ipv6 add 2004::1 64<br>int g0/0<br> mac-add 0000-0c00-0111<br> ipv6 add auto</p>
<h2 id="ripng"><a href="#ripng" class="headerlink" title="ripng"></a>ripng</h2><p>ripng 1<br>int g0/2<br> ripng 1 enable<br>int g0/0<br> ripng 1 enable</p>
<p>dis ipv6 rout pro ripng</p>
<h2 id="ospfv3"><a href="#ospfv3" class="headerlink" title="ospfv3"></a>ospfv3</h2><p>syst<br>ospfv3 1<br> router-id 4.4.4.4<br> import-route ripng 1 allow-direct</p>
<p>int g0/2<br> ospfv3 1 area 0</p>
<p>dis ipv6 routi pro ospfv3<br>dis ospfv3 peer<br>dis ospfv3 lsdb</p>
<h2 id="过渡"><a href="#过渡" class="headerlink" title="过渡"></a>过渡</h2><p>int tunnel 0 mode ipv6-ipv4<br> ipv6 add 2222:: 64 eui-64<br> ospfv3 1 area 0<br> source g0/1<br> destin 10.0.23.2</p>
<p>ip route-s 0.0.0.0 0 100.100.100.1  默认路由</p>
<h1 id="MSTP配置"><a href="#MSTP配置" class="headerlink" title="MSTP配置"></a>MSTP配置</h1><p>首先已配置完成VLAN、Access和Trunk端口。</p>
<p> 1.启用STP： stp  enable</p>
<p> 2.用MSTP模式：stp  mode  mstp</p>
<p> 3.进入MSTP配置视图：stp  region-conf</p>
<p> 4.定义区域名称：region-name 名</p>
<p> 5.定义修订等级：revision-level 号</p>
<p> 6.定义VLAN关联表：instance 实例号  vlan  VLAN范围</p>
<p> 7.激活配置：active  region-conf</p>
<p> 8.退出MSTP配置视图：quit</p>
<p> 9.定义主备根：stp  instance  实例号  root  p（主根）或s（备根）</p>
<p> 10.检查：dis stp br，dis stp region-conf</p>
<h1 id="VRRP（Virtual-Router-Redundancy-Protocol，虚拟路由冗余协议）"><a href="#VRRP（Virtual-Router-Redundancy-Protocol，虚拟路由冗余协议）" class="headerlink" title="VRRP（Virtual Router Redundancy Protocol，虚拟路由冗余协议）"></a>VRRP（Virtual Router Redundancy Protocol，虚拟路由冗余协议）</h1><p> 开放，RFC3768，用224.0.0.18，协议号=112。</p>
<p><strong>VRRP Router**</strong>角色**（dis vrrp）</p>
<p><strong>一.Master**</strong>：**主用</p>
<p> 选择：1.优先级最高（可抢占）；2.IP最高（不可抢占）。</p>
<p> 作用：1.用VMAC应答主机ARP请求；2.转发用户Data。</p>
<p><strong>二.Backup**</strong>：**备用</p>
<p> 监听Master定期（1秒）发送的通告，在Master_Down_Interval时间内未收到，则认为Master失效，立即成为Master，即切换。</p>
<p><strong>启用VRRP**</strong>（接口视图）：<strong>vrrp  vrid  组号  virtual-ip  虚拟IP（</strong>VIP**）</p>
<p> 检查：dis vrrp</p>
<p><strong>Virtual IP Address**</strong>（VIP<strong>**）：手工配置。</strong></p>
<p><strong>Virtual MAC**</strong>（VMAC<strong><strong>）：0000-5e00-01XX</strong></strong>（XX<strong>**：组号）</strong></p>
<p> <strong>查看：</strong>Router用dis vrrp，dis arp；主机用arp -a</p>
<p><strong>VRRP**</strong>状态机（**dis vrrp）</p>
<p>1.Master：主用；2.Backup：备用；3. Initialize：接口shutdown。</p>
<p><strong>VRRP**</strong>优先级**</p>
<p>默认=100，可用于定制Master。</p>
<p><strong>定制Master</strong></p>
<p> 接口视图修改优先级：vrrp  vrid  组号 priority  优先级</p>
<p><strong>回切</strong></p>
<p>如果优先级高的原Master恢复，则抢占为Master，即回切。</p>
<p><strong>VRRP**</strong>联动功能**</p>
<p>接口跟踪（Track）功能，当上行链路（Uplink）down时，Master降低优先级（默认降低10），进行主备切换；当上行链路恢复up，原Master恢复优先级，抢占为Master，即回切。</p>
<p><strong>VRRP**</strong>负载分担**</p>
<p> 可用多个组，每个组可对应一个VLAN，不同组有不同的Master。</p>
<h1 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h1><p><strong>安全区域（Zone**</strong>）：**用于区分不同的网络。默认4个Zone。（dis zone）</p>
<p> 1.local：代表防火墙本身。</p>
<p> 2.trust：可连接内部（Inside）网络。</p>
<p> 3.untrust：可连接外部（Outside）网络，即Internet。</p>
<p> 4.dmz：可连接放置允许外部访问的服务器群（Server Farm）的网络。</p>
<p><strong>安全级别（Security Level**</strong>）：<strong>dis Zone显示为priority。表示受信任程度。可用于定义报文</strong>流动的方向。**</p>
<p> <strong>高到低：Outbound**</strong>；低到高：Inbound<strong>**。</strong></p>
<p><strong>华为USG**</strong>基本配置**</p>
<p>以下为USG5500型，6000型见课件。</p>
<p>1.添加接口到区域（Zone）：firewall  zone  Zone名</p>
<p>​             Add  interface  接口号（dis  zone）</p>
<p>\2. 接口IP地址。</p>
<p>\3. DHCP服务器（接口视图）：</p>
<p> Dhcp select interface</p>
<p> dhcp server dns-list DNS服务器IP</p>
<p>4.安全策略：policy  interzone  Zone名 Zone名 inbound或outbound </p>
<p>​       policy 号（执行顺序）</p>
<p>​       action permit（允许）</p>
<p>5.检查：会话表：Display firewall session table</p>
<p>​    老化时间:：display firewall session aging-time</p>
<p> <strong>NAT No-PAT</strong></p>
<p>以前称为NAT， 用公有IP地址池中的IP，“<strong>一对一地址转换</strong>”。<strong>不常用！</strong></p>
<p>syst</p>
<p>nat address-group 1 100.100.100.12 100.100.100.13</p>
<p>nat-policy interzone trust untrust outbound </p>
<p> policy 1</p>
<p> action source-nat </p>
<p> address-group 1 no-pat</p>
<p><strong>NAPT</strong></p>
<p>以前称为PAT，用公有IP地址池中的IP<strong>及端口号</strong>，“<strong>多对一的地址转换</strong>”，常用于企业访问Internet。</p>
<p>sys</p>
<p>nat address-group <strong>2</strong> 100.100.100.14 100.100.100.15（公有IP地址池）</p>
<p>nat-policy  interzone  trust untrust  outbound </p>
<p> policy 1</p>
<p> action source-nat </p>
<p> address-group <strong>2</strong></p>
<p>dis  firew session  table</p>
<p><strong>配置策略NAPT</strong></p>
<p>用于控制上网的用户。</p>
<p>nat-policy interzone trust untrust outbound</p>
<p> policy 1</p>
<p> policy source 192.168.0.2 0（允许上网的用户）</p>
<p> action source-nat</p>
<p> address-group 2</p>
<p>dis  this</p>
<p><strong>NAT-Server</strong></p>
<p>用于公网用户访问DMZ的服务器。即将公网IP地址映射为服务器的私网IP地址。</p>
<p> nat server protocol tcp global 100.100.100.172 80 inside 172.16.1.101 80（dis nat server）</p>
<h2 id="ASPF-（Application-Specific-Packet-Filter-）"><a href="#ASPF-（Application-Specific-Packet-Filter-）" class="headerlink" title="ASPF**（Application Specific Packet Filter**）"></a><strong>ASPF**</strong>（Application Specific Packet Filter<strong>**）</strong></h2><p> 可对应用层协议进行深度检测，支持多通道协议（FTP等）、实时通讯工具（如QQ等）通过NAT设备的转发。</p>
<p>sys<br>firew interzone untrust dmz<br> detect ftp<br>firew interzone trust untrust<br> detect qq</p>
<p>dis firew server-map</p>
<h1 id="GER-VPN"><a href="#GER-VPN" class="headerlink" title="GER VPN"></a>GER VPN</h1><p>sys<br>int tunnel 0 mode gre<br>ip address 10.1.2.1 24<br>source 192.13.2.2<br>destination 132.108.5.2<br>display ip int br</p>
<h2 id="IPsec-vpn"><a href="#IPsec-vpn" class="headerlink" title="IPsec vpn"></a>IPsec vpn</h2><p>sys</p>
<ol>
<li>ACL<br>acl adv 3001<br>rule permit gre source 192.13.2.2 0 destination 132.108.5.2 0<br>quit </li>
<li>IKE<br>ike keychain k1<br>pre-shared-key address 132.108.5.2 24 key si 123456<br>qu<br>ike profile p1<br>keychain k1<br>match remote identity address 132.108.5.2 24<br>qu</li>
<li>IPsec<br>ipsec transform-set tr1<br>encapsulation-mode tunnel<br>protocol esp<br>esp encryption-algorithm aes-cbc-128<br>esp authentication-algorithm sha1<br>qu</li>
<li>MAP<br>ipsec policy map1 20 isakmp<br>security acl 3001<br>transform-set tr1<br>local-address 192.13.2.2<br>remote-address 132.108.5.2<br>ike-profile p1<br>return<br>sys<br>interface g 0/1<br>ipsec apply policy map1<br>qu</li>
</ol>
<p>display ike sa<br>display ipsec sa </p>
<h1 id="DHCP-Snooping"><a href="#DHCP-Snooping" class="headerlink" title="DHCP Snooping"></a><strong>DHCP Snooping</strong></h1><p>用DHCP Option82建立和维护真实IP、真实MAC、VLAN、接口对应的绑定表（dis dhcp snooping user-bind all）；将端口分别设为信任（可转发DHCP报文）或不信任（丢弃DHCP报文）。</p>
<p><strong>一.**</strong>用于防止DHCP<strong>**饿死攻击</strong></p>
<p>用绑定表对照检查DHCP报文CHADDR的字段，不一致则丢弃。</p>
<p>二.<strong>用于防止仿冒DHCP Server**</strong>攻击**</p>
<p>只有连接合法DHCP Server的端口设为信任。</p>
<p>三.<strong>用于防止ARP**</strong>中间人攻击**</p>
<p>用绑定表发现MAC欺骗，丢弃ARP报文。</p>
<p><strong>配置DHCP Snooping</strong></p>
<p> 1.全局启用DHCP：dhcp enable</p>
<p> 2.全局启用DHCP Snooping：dhcp snooping enable</p>
<p> 3.接口中启用Option82：dhcp option82 insert enable</p>
<p> 4.接口中启用DHCP Snooping：dhcp snooping enable</p>
<p> 以上配置后全部端口为不信任。</p>
<p> \5. 连接合法DHCP Server的端口设为信任（接口中）：dhcp snooping trust</p>
<p> 6.绑定表：dis dhcp snooping user-bind all</p>
<h1 id="端口安全-Port-Security"><a href="#端口安全-Port-Security" class="headerlink" title="端口安全(Port Security)"></a><strong>端口安全(Port Security)</strong></h1><p> 捆绑合法MAC到端口，防止仿冒用户接入，可用于<strong>接入层**</strong>Switch<strong>。限制端口MAC数量，可用于</strong>汇聚层<strong>**Switch</strong>。</p>
<p><strong>端口安全MAC**</strong>类型**</p>
<p> <strong>1.**</strong>安全动态MAC<strong>**地址</strong></p>
<p>启用端口安全后动态学习的MAC地址，设备重启后会丢失表项。(dis mac-add Security)</p>
<p> <strong>2.**</strong>安全静态MAC<strong>**地址</strong></p>
<p>手工捆绑的静态MAC地址，设备重启后不丢失表项。(dis mac-add sticky)</p>
<p> <strong>3.</strong> <strong>Sticky MAC**</strong>地址**</p>
<p>启用端口安全后，启用Sticky MAC功能后将动态学习的MAC地址转换为Sticky MAC地址，设备重启后不丢失表项。(dis mac-add sticky)</p>
<p><strong>端口安全限制动作</strong></p>
<p>超出端口安全MAC地址限制数后的动作。</p>
<p> <strong>1.</strong> <strong>restrict</strong></p>
<p>丢弃非法报文(源MAC不存在的报文)并告警(产生Log)，默认。</p>
<p> <strong>2.</strong> <strong>protect</strong></p>
<p>丢弃非法报文不告警。</p>
<p> <strong>3.</strong> <strong>shutdown</strong></p>
<p>接口置为error-down，并告警。必须在接口视图下用restart命令重启接口。</p>
<p><strong>配置端口安全</strong></p>
<p> 1.进入接口视图：interface 接口号</p>
<p> 2.启用端口安全：port-security  enable</p>
<p> 3.启用Sticky MAC：port-security  mac-address  sticky</p>
<p> 4.手工捆绑静态MAC地址：port-security  mac-address sticky xxxx-xxxx-xxxx(MAC地址)  vlan  号 </p>
<p> 5.限制端口MAC数量(默认=1)：port-security max-mac-num MAC地址上限(可用于<strong>汇聚层**</strong>Switch**)</p>
<p> 6.端口安全保护动作(默认为restrict)： port-security  protect-action  protect 或restrict 或shutdown</p>
<p> 7.检查：dis mac-add ， dis mac-add security， dis mac-add sticky</p>
]]></content>
  </entry>
</search>
